# 6.5 Decentralized Random Number Generator

The module presented in this specification allows for the decentralized generation of randomness for the post-coordicide IOTA network. The dRNG protocol is divided into three phases:

1. COMMITTEE SELECTION: In the first phase, a committee of high consensus mana nodes is selected. The procedure is objective i.e., all of the nodes in the network reach consensus on which nodes should be in the committee.
In order for a node to be considered as a candidate to the committee, it needs to declare its willingness to participate, with a special _application message_. When all of the required application messages are recorded in the Tangle, the `n` top mana holders among the candidates are selected as the committee. In the case where some of the required messages fail to be produced, the committee selection will consequently fail as well.

2. DKG PHASE: In the second setup phase, the committee members create a collective private key -which will be used later to generate the random number-, using the $(t,n)$ Distributed Key Generation (DKG), that does not rely on centralized, trusted third parties. The participation of the nodes in this phase can be publicly verified, since he message exchange here is made in the Tangle. 

3. PUBLICATION PHASE: This last phase consists on the periodical publication of the beacon messages in the Tangle. A single individual beacon message should not be sufficient to reveal the random number; instead, the beacon messages from at least $t$ out of $n$ committee members are needed for the next random number being revealed. Additionally, the committee members may publish a collective beacon message, which would contain the (already computed) random number. 

A large part of the procedures in this specification is based on the article:
 
https://arxiv.org/abs/2102.03139
 
Where authors discuss multiple methods of the committee selection and applications.

 
 
 
  
  
  
  
# 6.5.1 Dependencies  
  
  
1. Mana  
    Mana is necessary in dRNG. We use it to find the most trustworthy nodes in the network. Later those nodes and form a committee that produces the random numbers. 
  
2. FPC  
    Random numbers produced by dRNG are used in FPC voting.
 
  
  
  
  
  
  
# 6.5.2 Outline 
 
The random number generation procedure is divided into three phases. 
 
**1. COMMITTEE SELECTION:**  
In this phase, the network finds the most trustworthy nodes in the network. The trust level is determined with mana, which measures how much of a “skin in the game” nodes have. The procedure is objective i.e., all of the nodes in the network reach a consensus on what nodes should be in the committee.  
  
In order for a node to be in the committee which produces random numbers, it needs to declare its willingness to participate, with a special ''application'' message. When all of the application messages are recorded in the Tangle, $n$ top mana holders are selected to be on the committee.   
  
  
**2. DKG PHASE:**  
  
Distributed key generation phase. Takes place on the Tangle. The participation of committee nodes can be publicly verified. It is required to establish a collective key used to generate randomness.   
  
**3. PUBLICATION PHASE:**  
  
Publication of the beacon messages in the Tangle. In this phase committee nodes periodically publish randomness in the Tangle. Other nodes can read the random number directly from the Tangle public ledger.  
  
  
  
  
  
  
# 6.5.3 Parameters !!! 
  
  
  
## Dependencies 

The dRNG module depends on the Mana module, since it uses the Consensus Mana vector as a measure of trustworthiness. Specifically, it uses the list of the top Mana holders to select a committee to produce the random numbers. During the committee selection, we do not assume a perfect agreement on the mana values, i.e., different nodes can have slightly different perceptions of the mana values of other nodes. Obtaining consensus on the mana values is the central part of this documentation. 

# 6.5.1 Parameters  

1. The random number production frequency: $t_{ran}$  
    *Random number is produced every $t_{ran}$ seconds.*  
    **Suggested value**: $t_{ran}= 10$ $[sec]$ 

2. Number of nodes in the committee: $m, m_2$.  
    *The committee's size from top mana holders equals $m$; the size of the pre-selected committee (responsible for random backup number) equals $m_2$.*  
    **Suggested value**: $m= 10$ $[nodes]$, $m_2= ??????????$ $[nodes]$    
  
3. Committee seat sizes: $n, n_2$  
      *The number of identities (seats) in the top mana holders committee equals $n$. The number of seats in the pre-selected committee equals $n_2$. $n$ does not necessarily equals $m$ and $n_2$ does not necessarily equals $m_2$, as specific nodes receive multiple seats when they publish more than one beacon message.*  
    **Suggested value**: $n= 15$ $[nodes]$, $n_2= ??????????$ $[nodes]$  
  
4. Signature threshold parameter: $f \in [0,1]$ (percentage), $t \in \mathbb{N}$ (number of beacon messages needed to obtain randomness)  
      *In order to find the next random number, $t$ or more beacon messages are required. ($t =\lfloor nf \rfloor +1$).*  
    **Suggested value**: $f = 0.51$, $t=8$ $[nodes]$    
  
5. Frequency of committee update: $Freq$.  
      *A new committee is selected every $Freq$ unit of time.*  
    **Suggested value**: $Freq. = 1$ $[day]$    
  
6. Time window of the ''application'' message submission: $\Delta_A$  
    *Nodes that want to be members of the committee have to issue a special ''application'' message in the angle within the time window, which lasts for $\Delta_A$   units of time.*  
    **Suggested value**: $\Delta_A =2$ $[min]$  
  
7. Time delay bound on the dRNG messages: $D$    
    *The network does not accept the dRNG messages with the timestamp off by more than $D$ from the node's local time. This parameter is defined in the (OBJECT OF CONSENSUS???) specification. (SAY SOMETHING ABOUT LOK)*  
    **Suggested value**: $D = ??? [min]$ (TO BE DETERMINED LATER ) 
  

# 6.5.2  Committee selection  

5. Frequency of committee selection: $Freq. = 1$ $[day]$  
  
6. Time interval for committee ''application'' submission $\Delta_A =2$ $[min]$  
  
7. Time delay bound of the dRNG messages: $D = ??? [min]$ (TO BE DETERMINED LATER )  ??
  
  
 
 
 
  
# 6.5.4  Committee selection  


   
To select the committee based on the consensus mana, we need to achieve consensus on these values. Unfortunately, due to the small differences in clocks and ledger states, nodes may have different views on mana. To solve this problem, we must introduce a reference point that can be used to calculate the consensus mana values in an objective manner. 
  
The Tangle graph after coordicide lacks a natural reference point to calculate mana values. Notice that this reference point is quite straightforward to define in blockchain based ledgers (every multiple of $k$ block height, for instance). We introduce then a reference point using timestamps of the transactions, which are objective and consequently not subject to local clocks discrepancies.

The willingness to participate in the committee is announced with a special application message, which -like any other transactions in the tangle- are equipped with timestamps. Since the nodes following the protocol judge and invalidate messages which timestamps are too off, we can assume that the application messages can reliably give us a list of nodes interested in joining the committee. 
 
## 6.5.2.1 Application messages  
  
Any node can issue an application message. Such a message would be processed by the nodes (assuming it passes the congestion control, along with other checks). However, for a low mana node, there is no incentive to apply for the committee, as the probability of being selected is very low; hence, they can decide to not take part in sending application messages. Although it is allowed, sending multiple application messages is pointless and costly due to the congestion control mechanism.  
  
Assume that a committee should be formed at the time $t_0$ (which is known to all interested nodes; it is defined on the protocol level). Recall that the maximal accepted difference between a received message timestamp and the local clock is $D$ (see [Section]). Therefore, if the largest possible timestamp of an application message is $t_{last}$, then every node can be relatively sure that this message will not be received after the time $t_{last}+D$ (with respect to the receiving node’s local clock). Now, let us denote $T_0 = t_0 - D$. As $t_0$ is known to all nodes, so it will be $T_0$. We then require the potential committee members to issue an application message in the Tangle with a timestamp from the interval $[T_0 -\Delta_A, T_0]$. The mana value of all nodes will be calculated for the time $T_0$, that will act as our reference point. Notice that, if all application messages are sent in the interval $[T_0 -\Delta_A, T_0]$, they should be available to all the nodes somewhere in the interval $[T_0 -\Delta_A, t_0]$, meaning that at time $t_0$ it should be known if the committee was successfully formed. 
  

### 6.5.2.1.1 Application message sending - default algorithm 
 
A node is said to be $M_\ell$ if it is among top $\ell$ top mana nodes (with respect to the time $T_0 -\Delta_A$).  
  
If an interested node $x$ is $M_{2m}$ (where $m$ is the committee size) then it issues an application at the time $T_0-\Delta_A$. Notice that, in general, not all of the $2m$ application messages will be sent. If less than $m$ valid application messages are sent at $T_0-\Delta_A$, the nodes that are $M_{3m}$ (but not $M_{2m}$) shall issue their application messages at $T_0- \Delta_A \frac{1}{2}$ and so on. In general, for $k>2$, if a node $x$ is $M_{m k}$ but not $M_{m (k-1)}$, it will submit a committee application whenever before the time $T_0- \Delta_A \frac{k-2}{k-1}$ there are less than $m$ valid application messages with c-Mana greater than the c-Mana of node $x$.  

Pseudocode:  
```  
if (this_node_wants_to_participate_in_dRNG) then  
    if (time == T_0-Delta_A)  
        ell = what_is_my_ell_number(my_ID,MANA_vector)  
        CALL APPLICATION_MESSAGE_SEND(ell)  
    fi  
fi  
```  
  
```  
subroutine APPLICATION_MESSAGE_SEND(ell)  
if (ell <= 2m) then  
    timestamp = T_0-Delta_A  
    send_application_message(timestamp)  
else  
    wait_until(T_0- Delta_A *[1-(floor(ell/m)-2)/(floor(ell/m)-1)])  
    if (number_of_valid_application_messages_with_mana_higher_than_mine < m) then  
        send_application_message(T_0- Delta_A *[1-(floor(ell/m)-2)/(floor(ell/m)-1))  
    fi  
fi  
endsubroutine  
```   
If at least $m$ of the nodes sent an application message within the time interval, the committee is formed from the top $m$ mana nodes who applied. Due to the network delay, this can be confirmed only at the time $t_0$.  
  
If less than $m$ nodes send application messages, then the committee selection will fail. In this case, the procedure should be repeated after a new time window of $\Delta_A$; i.e., if the failed committee selection looked for application messages in the interval $[T_n -\Delta_A, T_n]$, then the procedure is repeated scanning the interval $[T_n, T_n+\Delta_A]$.

# 6.5.3 DKG phase  
  
After a successful committee selection -confirmed at the time $t_0$ with respect to node's local clock-, the DKG phase starts. In this phase, the committee nodes exchange the *Deal messages* to produce a public/private collective key. Nodes should proceed with DKG message exchange as soon as the committee selection is confirmed (time $t_0$).

If any committee node refuses to create a collective key pair by not exchanging Deal DKG messages, the DKG phase fails. This can be confirmed at the time $t_0 + D$ (using the node's local clock). Moreover, since the message exchange occurs on the Tangle, everybody can identify nodes that caused the failure. In DKG phase failure, the entire committee selection is repeated. The malicious node can then be excluded from the new committee on the process by modifying mana to zero. This modification is applied only to the mana used in dRNG module. Mana values used for other purposes are unchanged. Moreover, modification is lifted after the committee is *successfully* selected, i.e., the committee produces its first beacon messages.  
  
If DKG phase failure is confirmed a the time $t_n + D$, then the committee selection is repeated with a new expected time of committee selection $t_{n+1} = t_n +2\times D+\Delta_A$.  
 
We can increase the security of dRNG beacon by granting double seats to the half of the committee members that have the highest mana. Those nodes would receive two private keys (identities) with which they sign beacon messages in the Tangle. From the technical point of view, two seats are completely separate, and issued messages can not be combined (even though they were signed by the same node). This modification increases the amount of mana required to "overtake" the committee, which is understood as gaining $t$ of seats in the committee. Without it, an attacker could gain more than $t$ seats in the committee with about 12% mana for $m=15$. Using the double seat proposal, the minimal mana required to overtake the commitee doubles.  
  
The total number of nodes with double seats equals $\lfloor m/2 \rfloor$ which makes the total number of identities in the committee equal $m + \lfloor m/2 \rfloor$.
 
# 6.5.4 Publication of the random number 
 
The committee will collectively generate a random number based on the set of beacon messages that each node will individually produce. A single beacon message should not be sufficient to reveal the random number; instead, $t$ or more beacon messages are needed for the next random number being revealed. 

## 6.5.4.1 Collective beacon message  
  
To recover the random number from the individual beacon messages, all nodes in the network would need to perform Lagrange interpolation. To avoid that, we propose that the committee nodes produce a _collective beacon message_, which contains pre-computed random numbers (meaning that the committee nodes will perform the Lagrange interpolation on their own). Since the committee size is small and the expected throughput of the network is large, we require all committee members to produce this collective beacon message as soon as they receive $t$ individual beacon messages. 
  
The cost of getting randomness from the collective beacon would be reduced as only (additionally to the default message checks) the signature verification would be required.  
  
In the unlikely event that the random number is required at a time that the collective beacon is still unavailable (provided that more than $t$ individual beacon messages are already published), then the nodes can perform the Lagrange interpolation by themselves.  

# 6.5.5 Duties of the old committee  
  
An old committee should only stop producing randomness if another committee was successfully selected and started producing random numbers, which will be confirmed when $t$ or more individual beacon messages are produced by the new committee and can be read directly from the Tangle.  

# 6.5.6 Community dRNG  
  
Although unlikely, it is still possible that the mana committee fails to produce a random number. To increase the liveness of the random number production in the post-coordicide IOTA, we will deploy multiple dRNGs. The first alternative (deployed with the coordicide) is the committee dRNG. It uses the same cryptographic $(t,n)$-scheme, but the committee is pre-selected from community members. Details of the random number usage from different sources in FPC are described in specification FPC (LINK???)  
  
# 6.5.7 Payload layout  
  
## Application messages  
  
Committee candidature payload  
| Field | Type | Description |  
|------------|--------|----------------------------------|  
| type | byte | message type |  
| instanceID | uint32 | identifier of the dRAND instance |  
   
## DRK generation  
  
Deal payload  
| Field | Type | Description |  
|------------|---------------|----------------------------------|  
| type | byte | message type |  
| instanceID | uint32 | identifier of the dRAND instance |  
| fromIndex | uint32 | index of the dealer |  
| toIndex | uint32 | index of the verifier |  
| deal | encryptedDeal | encrypted share |  
  
encryptedDeal struct  
| Field | Type | Description |  
|----------------|--------|-------------------------------------------------------------------------------|  
| dhkey | bytes | ephemeral Diffie-Hellman key |  
| nonce | bytes | nonce used in AES-GCM |  
| encryptedShare | bytes | ciphertext of the share |  
| threshold* | uint32 | threshold of the secret sharing protocol (decided during committee selection) |  
| commitments | bytes | commitments of the polynomial used to derive the share |  
  
## Randomness revealing messages  
  
Beacon payload  
| Field | Type | Description |  
|------------------|--------|----------------------------------------------------------------|  
| type | byte | message type |  
| instanceID | uint32 | identifier of the dRAND instance |  
| round | uint64 | round of the current beacon |  
| partialPubKey | bytes | public key of the issuer |  
| partialSignature | bytes | partial signature of the beacon |  
  
Collective beacon payload  
| Field | Type | Description |  
|---------------|--------|------------------------------------------------|  
| type | byte | message type |  
| instanceID | uint32 | identifier of the dRAND instance |  
| round | uint64 | round of the current beacon |  
| previous | bytes | signature of the pn beacon |  
| signature | bytes | signature of the new beacon |  
| distributedPK | bytes | distributed public key |  
  
  
  
  
  
  

# 6.5.10 Further research and planned improvements 

1. Committee failure detection and recovery mechanism

2. Backup random beacon based on VDFs

3. How much mana does the attacker need to overtake committee and multiple seats in the committee – further research



