# 5.3 Decentralised Random Number Generator for IOTA network - Specification


This specification is part of IOTA 2.0 [Coordicide](https://coordicide.iota.org/).

The module presented in this specification, decentralized random number generator (dRNG), allows for the decentralized generation of randomness for the IOTA 2.0 network. The dRNG protocol is divided into three phases. In the first phase, a committee of high mana nodes is selected. In the second, setup phase, the selected committee members create a collective private key which is used in the third, beacon phase, where the random numbers are published in the Tangle. 

During the committee selection we do not assume perfect agreement on the mana values  i.e: different nodes can have slightly different opinions on the mana values of other nodes. Obtaining the consensus on the mana values is the main part of this module. In the setup phase, a pair of collective private and public key is created in such a way that no individual committee member knows the entire private key. This is done using $(t,n)$ Distributed Key Generation (DKG), which does not rely on centralized trusted third parties. In the beacon phase messages containing random number can be signed with private collective key when at least $t$ of the $n$ committee nodes sign message with theirs private key share. All of the random number messages used in three phases are published in the Tangle 


In the IOTA 2.0 decentralized random numbers are used in the FPC. Randomness increases the security of this consensus mechanisms by keeping the voting threshold unknown for the potential attacker. We However, FPC can be decoupled from random numbers and the network is not halted if randomness is not produced anymore (although security suffers). Possible usage of dRNG for other modules like autopeering, rate control or smart contract are discussed, although currently we do not plan to deploy them.

To provide the dRNG for IOTA 2.0, we decided to use already existing works, including [Rabin](http://www.sciencedirect.com/science/article/pii/0022000083900429), [Shamir's Secret Sharing](https://en.wikipedia.org/wiki/Shamir%27s_Secret_Sharing); [Petersen secret sharing](https://www.cs.cornell.edu/courses/cs754/2001fa/129.PDF); (Boneh–Lynn–Shacham (BLS) signature scheme)[https://en.wikipedia.org/wiki/Boneh%E2%80%93Lynn%E2%80%93Shacham]; Syta (https://bford.info/pub/dec/random.pdf) and most notably open-source, practical implementation of dRNG: [drand](https://drand.love/). In this specification we use the same cryptographic foundations as drand. Full specification of the drand protocol can be found here: https://github.com/drand/drand. We highly recommend reading it before continuing this specification. In particular the part responsible for [Drand: Cryptographic Background](https://hackmd.io/@nikkolasg/HyUAgm234). It describes both DKG and beacon phases on the cryptographic level. Since we adapted the same threshold scheme we do not repeat this here. 





# 5.3.1 Dependencies


1. Mana

2. FPC

Possibly, in the future:

3. Autopeering

4. Rate control








# 5.3.2 Outline of the decentralized random number generation

**1. COMMITTEE SELECTION:**

a) Nodes declare their willingness to be a committee member with a special ''application'' message

b) Selection of $n$ top mana holders


**2.  DKG PHASE:**

Distributed key generation phase. Takes place on the Ttangle, participation can be publicly verified

**3. PUBLICATION PHASE:**

Publication of the beacon messages in the Tangle 

   




# 5.3.3 Parameters





1. The random number production frequency:  $t_{ran}$

*Random number is produced every $t_{ran}$ seconds.*



2. The number of participating nodes: $m, m_2$.

*The committee's size from top mana holders equals $m$; the size of the community committee (responsible for random backup number) equals $m_2$.*



3. Committee seatizes:   $n, n_2$

*The number of identities (seats) in the high mana committee equals $n$. $n$ does not equal $m$ as  certain nodes receive more than one seats, i.e.: node publishes more than one beacon message.* 



4. Signature threshold parameter: $f \in [0,1]$ (percentage), $t \in \mathbb{N}$ (number of beacon messages needed to obtain randomness)

*In order to find the next random number, $t$ or more beacon messages are required. $\left ($t =\lfloor nf \rfloor +1 \right )$).*



5. Frequency of committee update:  $Freq.$

*The committee is selected every $Freq.$ units of time.*



6. Time window of the ''application'' message submission:  $\Delta_A$
*Nodes that want to be in the committee have to issue a special ''application'' message in the Tangle within the time window, which lasts for $ \Delta_A $ units of time.*



7. Time delay bound on the dRNG messages: $D_{RN}$

*The network does not accept the dRNG messages with the timestamp off by more than $D_{RN}$ from node's local time.*

8. Size of $\mathbb{Z}_{p}$ group: $p$



# 5.3.5 Committee selection




To select the high mana committee, we need a consensus on the mana values. Unfortunately, different nodes have different views on the mana values, due to the slightly different clock. 

The Tangle in IOTA 2.0 lacks an obvious 'reference point' which could be used to calculate mana values. This is not a problem in blockchains where such reference point could be every 1000-th block; neither it is a problem in IOTA 1.0 where milestones could be such reference point. To solve this problem we use the timestamps of the transactions and use specific time as a reference point. Application messages are used to determine weather the node wants to participate in the committee, then the committee is formed from top $n$ highest mana holders.

The committee selection process is analyzed in depth in this article: 
XXX (submitted to the conference, still in revive)

In this article we also describe alternative methods of committee selection and analyze DAG distributed ledgers other than the Tangle. 


## 5.3.5.1 Application messages



Application messages have to submitted within time window of $\Delta_A$ units of time. 

In general, any node can issue an application message, and such a message would be accepted by the Tangle (assuming it passes rate control). However, we admit that for a low mana node, such behavior does not make much sense. Such nodes can decide not to take part in it.  Multiple application messages are allowed. However, they are pointless and in fact rate control costly as they do not bypass rate control. 



Assume that the committee should be formed at the time $t_0$. Remember that $D_{RN}$ is bound on accepting dRNG messages in the Tangle. Then no honest node accepts dRNG message with the timestamp different by more than $D_{RN}$ from its local time.
Let us denote

$$
T_0 = t_0 - D_{RN}.
$$

Then we require the potential committee members to issue an application message in the Tangle with a timestamp from an interval.

$$
[T_0 -\Delta_A, T_0].
$$

Mana value of all of the nodes would be calculated with respect to the time $T_0 -\Delta_A$ (reference point).  



For nodes interested in committee participation we provide a default application algorithm that tells node when to apply. Nodes can modify it, however we encourage them to stick with it as it reduces the number of exchanged application messages.  


A node is said to be $M_\ell$ if at the time $T_0 -\Delta_A$  it is among top $\ell$ top mana nodes. 



If a node $x$ is $M_{2m}$ then it issues an application at the time $T_0-\Delta_A$.


For $k >2$ and a node $x$ which is $M_{m\cdot k}$ but not $M_{m\cdot (k-1)}$ ($m$ is the committee size) it submits a committee application if before the time $T_0- \Delta_A \frac{\ell-2}{\ell-1}$ there is less than $m$ valid application messages with mana greater then $x$'s mana. 



Pseudocode:
```
if (this_node_wants_to_participate_in_dRNG) then
if (time == T_0-Delta_A)
ell = what_is_my_ell_number(my_ID,MANA_vector)
CALL APPLICATION_MESSAGE_SEND(ell)
fi
fi
```

```
subroutine APPLICATION_MESSAGE_SEND(ell)
if (ell <= 2) then
timestamp = T_0-Delta_A
send_application_message(timestamp)
else
wait_untill(T- Delta_A *(ell-2)/(ell-1))
CALL what_is_my_mana
if (number_of_valid_application_messages_with_mana_higher_than_mine < m) then
send_application_message(timestamp)
fi
fi
endsubroutine 
```



If $m$ or more valid application messages had been issued to the Tangle then the committee selection is considered valid and committee is formed from top $m$ mana nodes who applied. 



If committee selection was a failure, then the procedure should be repeated until sucsesfull. In general if the failed committee selection was supposed to be selected at time $t_n$ then the new procedure is repeated  with a new expected time of committee selection $t_{n+1} = t_n + D_{RN}+\Delta_A$



# 5.3.6 DKG phase

After successful committee selection, confirmed at the time $t_0, the DKG phase starts. In this phase committee nodes exchange Deal messages to produce a public/private collective key. Nodes should proceed with DKG message exchange as soon as committee selection is confirmed (time $t_0$). 


If any committee node refuses to create a collective key pair by not exchanging Deal DKG messages, then the DKG phase fails. This can be confirmed at the time $t_0 + D_{RN}$. Moreover, since the message exchange takes place on the Tangle, everybody can identify nodes which caused failure. In the case of DKG phase failure, entire committee selection is repeated. This assures that malicious nodes can be excluded from the committee, by modifying the malicious node's mana to zero. This modification is applied only to the mana used in dRNG module. Mana vaulues used for other purposes is unchanged. Moreover, modification is lifted after the committee is *successfully* selected i.e.: the new committee produces its first beacon messages.


If DKG phase failure is confirmed at the time $t_n + D_{RN}$, then the committee selection is repeated with a new expected time of committee selection $t_{n+1} = t_n +2*D_{RN}+\Delta_A$. 



# 5.3.7 Double seats in the committee

Our research revealed that we can increase the security of dRNG beacon by granting double seats for half of the committee with the highest mana. Those nodes would receive two private keys (identities) with which they sign beacon messages in the Tangle. From the technical point of view, two seats are completely separate, and issued messages can not be combined (even though physically signed by the same node). This modification increases mana required to "overtake" the committee, which is understood as gaining $t$ of seats in the committee. Without it an attacker could gain more than $t$ seats in the committee with about 12% of mana for $m=15$. With double seats proposal, minimal mana to overtake doubles. 


The total number of nodes with double seats equals $\lfloor n/2 \rfloor$ which makes the total number of identities in the committee equal

$$
n + \lfloor n/2 \rfloor = \left \lfloor 1\frac{1}{2}n \right \rfloor.
$$






# 5.3.8 Synching of the new committee nodes & duties of the old committee 

Before starting random number generations, committee nodes should synch up their clocks, with each other or some other central entity like atomic clock services.

Old committee should stop producing random numbers only if the new committee was successfully selected and started producing random numbers. This is confirmed when $t$ or more beacon messages are produced by the new committee and can be read directly from the Tangle.  



# 5.3.9 Community dRNG

Although unlikely, it is still possible that the mana committee fails to produce a random number. To increase livness of random number generator in the IOTA 2.0 we are going to deploy another dRNG which uses the same scheme, but the committee is pre-selected from community members. Details of the random number from different sources in FPC are described in specification XXX.  


In the future we want to also deploy backup randomness beacon based on VDFs. 



# 5.3.10 Collective beacon message

To recover the random number from beacon messages node needs to perform Lagrange interpolation. Although not very computationally costly, this procedure would need to be completed by each node in the network.



To avoid that, we propose that committee nodes produce the collective beacon message which contains already computed random number (committee nodes perform Lagrange interpolation on their own). Since the committee size is small and the expected number of TPS for IOTA large, we require all committee members to produce this collective beacon message as soon as they receive $t$ beacon messages.




The cost of getting randomness from collective beacon would be reduced as only the signature verification would be required.






Non-committee nodes behave as follows: If randomness is required at the time, when no collective beacon is available but more than $t$ beacon messages are published, then the nodes perform Lagrange interpolation themself.



# 5.3.11 Payload layout

## 5.3.11.1 Application messages

Committee candidature payload
| Field      | Type   | Description                      |
|------------|--------|----------------------------------|
| type       | byte   | message type                     |
| instanceID | uint32 | identifier of the dRAND instance |




## 5.3.11.2 DRK generation

Deal payload
| Field      | Type          | Description                      |
|------------|---------------|----------------------------------|
| type       | byte          | message type                     |
| instanceID | uint32        | identifier of the dRAND instance |
| fromIndex  | uint32        | index of the dealer              |
| toIndex    | uint32        | index of the verifier            |
| deal       | encryptedDeal | encrypted share                  |

encryptedDeal struct
| Field          | Type   | Description                                                                   |
|----------------|--------|-------------------------------------------------------------------------------|
| dhkey          | bytes  | ephemereal diffie hellman key                                                 |
| nonce          | bytes  | nonce used in AES-GCM                                                         |
| encryptedShare | bytes  | ciphertext of the share                                                       |
| threshold*     | uint32 | threshold of the secret sharing protocol (decided during committee selection) |
| commitments    | bytes  | commitments of the polynomial used to derive the share                        |


## 5.3.11.3 Rrandomness revealing messages

Beacon payload
| Field            | Type   | Description                                                    |
|------------------|--------|----------------------------------------------------------------|
| type             | byte   | message type                                                   |
| instanceID       | uint32 | identifier of the dRAND instance                               |
| round            | uint64 | round of the current beacon                                    |
| partialPubKey    | bytes  | public key of the issuer                                       |
| partialSignature | bytes  | partial signature of the beacon                                |


Collective beacon payload
| Field         | Type   | Description                                    |
|---------------|--------|------------------------------------------------|
| type          | byte   | message type                                   |
| instanceID    | uint32 | identifier of the dRAND instance               |
| round         | uint64 | round of the current beacon                    |
| previous      | bytes  | signature of the previous beacon               |
| signature     | bytes  | signature of the new beacon                    |
| distributedPK | bytes  | distributed public key                         |









# 5.3.12 Parameters values

1.  Random number produced every:  $t_{ran}= 10$ $[sec]$

2.  Committee size:   $m= 10$ $[nodes]$

3.  Identities in the committee:   $n= 15$ $[nodes]$

4. drand threshold parameter: $f = 0.51$, $t=8$ $[nodes]$

5. Frequency of committee selection:  $Freq. = 1$ $[day]$

6. Time interval for committee ''application'' submission  $\Delta_A =4$ $[min]$

7. Time delay bound of the dRNG messages: $D_{RN} = 2*w+D = 35 [min]$ ($w,D$ are values of the parameters from XXX)






## 5.3.13 Further research and planned improvements 

1. Committee failure detection and recovery mechanism

2. Backup random beacon based on VDFs

3. How much mana does the attacker need to overtake committee and multiple seats in the committee – further research

4. Probability of false-positive of committee failure detection (point 1)
