# 5.3 Decentralised Random Number Generator for IOTA network - Specification


This specifiaction is part of [Coordicide](https://coordicide.iota.org/).

The module presented in this specification, decentralized random number generator (dRNG), allows for the decentralized generation of randomness used in the IOTA network. The dRNG protocol is divided into two parts. In the first part, we provide a committee selection method. The committee is selected from the high mana nodes. We do not assume perfect agreement on the mana values  (different nodes can have slightly different opinions on the mana values of other nodes). In the second part, the committee members use a verifiable secret sharing and the threshold signature scheme to produce a random number. An example of such protocol is *drand* where committee members publish *beacon messages* which contain part of the randomness. Those messages are published in the Tangle. In the IOTA 2.0 network, decentralized random numbers are used in the FPC, rate control, and certain autopeering protocols (ar-row). 



# 5.3.1 Introduction


IOTA 2.0 requires a decentralized random number generator (dRNG) to increase the security on the FPC. It can also be used in is the ar-row autopeering protocol (which is currently not used but can be in the future) and can be used in salt-based autopeering (now used). It can also prevent transaction mining in the rate control mechanism. 

To provide the dRNG for IOTA 2.0, we decided to base our work on drand and adapt/develop it to work in the Tangle environment. The DEDIS research group develops drand (currently under: drand organization).  Drand organization currently runs a first test network composed by trustworthy organizations around the globe such as Cloudflare, EPFL, University of Chile and Kudelski Security. The main website of the first launch  is hosted at the league of entropy site: https://leagueofentropy.com


Full specification of the drand protocol can be found here: https://github.com/drand/drand


The IOTA 2.0 protocol's main random number is going to be produced by the committee made from high mana nodes. The top mana nodes proved to be valuable, reliable, and trustworthy for the network. Moreover, such nodes have ''the skin in the game,'' and it would be in their interest to maintain the network's security. Such committee members would be updated periodically. Nevertheless, even those reliable nodes can have certain problems like DDOS attacks or connectivity issues. To improve the reliability of the network, we use a backup, secondary random number beacons. Currently, we plan to use the pre-selected committee of IOTA community nodes as our backup dRNG. 







## 5.3.1.1 Other options: Threshold vs. VDF
Before going directly to the implementation details, we would like to mention other options for dRNG. Although the topic of decentralized randomness production is broad, and multiple choices are available; two schemes are well researched and tested. 

* VDF based
* Threshold signature-based

An example of the first one is RANDAO, which is a smart-contract in the blockchain-based DLTs. It is currently being worked on for the Ethereum 2.0. (for more see: [RANDAO specification](https://github.com/randao/randao)). 



Unsurprisingly, the main component of the VDF based dRNG solutions are VDFs (verifiable delay functions). A VDF  is a function that can only be computed sequentially in a certain number of steps, and incidentally time $ T $, such that anyone can verify it quickly, at most in $O(\log T)$. Valuable property is that the evaluation cannot be parallelized. For more see Introduction to VDF for the IOTA

https://app.slack.com/client/T4D3H4VGT/DJPBCMMGT/thread/CHX06PXPW-1586885304.015400)).



VDF removes the last actor problem by imposing physical time-wall to obtain randomness. 

A brief comparison of VDF and threshold signature-based solutions is provided below.


### VDF:
* Physical limits on predicting randomness (best ASICs)
* Single honest actor makes collusion impossible
* Liveness - after contributing randomness nodes can go offline
* Easy to verify on the users part
* Research on ASICs needed
* Requires actor who calculates VDFs
* Not usable for randomness frequency close to the network delay
 * Who contributes randomness?



### Threshold:

* Used in already deployed ``League of Entropy'' 
* Arbitrarily fast
* Easy to verify on the users part
* Open source code available 
* Setup phase required
* Possible collusion
* No calculations outside of the system required (VDF ASIC)
* Who contributes randomness?
        


VDF based dRNG for IOTA will be developed in the future as another backup option.  






# 5.3.2 Dependencies

The dRNG module depends on the following other modules:

1. Mana (to obtain a list of mana)
2. FPC
3. Autopeering
4. Rate control








# 5.3.3 Outline of the decentralized random number generation

1. COMMITTEE SELECTION

a) Nodes declare their mana with a special ''application'' transaction

b) Selection of $n$ top mana holders 


2.  DKG PHASE: 
Key signing phase on the tangle layer

3. PUBLICATION PHASE
Publication of the dRNG messages  in the Tangle

    




# 5.3.4 Parameters 





1. Random number production frequency:  $t_{ran}$ 
*Random number is produced every $t_{ran}$ seconds.*


2. Number of participating nodes: $m, m_2$. The committee's size from top mana holders equals $m$; the size of the pre-selected committee (responsible for random backup number) equals $m_2$.*

3. Committee sizes:   $n, n_2$
*The number of identities in the committee from top mana holders equals $n$; the number of identities in the pre-selected committee equals $n_2$.* $n$ is not equal to $m$ because certain nodes receive more than one identity, i.e.: node publishes more than one beacon message.  



4. Drand threshold parameter: $f \in [0,1]$ (percentage), $t \in \mathbb{N}$ (number of nodes)
*In order to produce a random number nodes require more or exactly $t$ secret revealing (beacon) messages ($t =\lfloor nf \rfloor +1$).*

 

5. Frequency of committee update:  $Freq.$
*The committee is selected every $Freq.$ units of time.*



6. Time interval of committee ''application'' submission:  $\Delta_A$ 
*Nodes that want to be in the committee have to issue a special ''application'' message in the Tangle within the time window, which lasts $ \Delta_A $ units of time.*




7. Time interval of committee communication to obtain distributed key:  $\Delta_C$ 
*The nodes selected to the committee should produce distributed key within $\Delta_C$. units of time*




8. Time delay bound of the dRNG messages: $D_{RN}$
The network does not accept the dRNG messages with the timestamp off by more than $D_{RN}$ from node's local time





























# 5.3.5 Committee selection

The committee selection process is described in more detail in the article: 
https://www.overleaf.com/read/jdbhppqyxsvx


To select the IOTA dRNG committee, we need consensus on the mana values of the top mana holders. However, in the Tangle, unlike in blockchains, there is no perfect consensus on the balances/mana and different nodes can have slightly different mana values. To achieve objective values of mana, we require all of the nodes interested in the committee participation to prepare a special ''application'' transaction, which determines it. Then the committee is formed from top $n$ highest mana holders.


## 5.3.5.1 Fixing mana perception



To obtain the consensus on the mana value of the top nodes, we require them to submit application messages to the Tangle. Application message contains information about their mana.
 


Assume that the committee should be formed at the time $t_0$. Remember that $D_{RN}$ is bound on accepting dRNG messages in the Tangle. Then no honest node accepts dRNG message with the timestamp different by more than $D_{RN}$ from its local time. 
Let us denote 

$$
T_0 = t_0 - D_{RN}.
$$

Then we require the potential committee members to issue an application message in the Tangle with a timestamp from an interval. 

$$
[T_0 -\Delta_A, T_0].
$$

At the time $t_0$ no new application message with a timestamp from $[T_0 -\Delta_A, T_0]$ can be accepted to the Tangle. If such a message would be issued, it should be treated as level 3 bad and not propagated. 


Such transactions would be used to extract *only* a mana value of an issuing node, i.e., manas of two potential committee members will be deduced from different transactions.  Application message contains a timestamp that determines mana value, i.e.: nodes calculate mana using only the transactions with a timestamp smaller or equal to the timestamp if the application transaction.



This method of committee selection has an advantage that only online nodes can apply to be a committee member. Moreover, if a particular node predicts that it will not be able to be a committee member for the entire period (for example, due to the planned maintenance), it can decide not to apply. 


If a node sends more than one application message, all of them are discarded. Those messages are not used for committee formation, and misbehaving nodes can be punished (in this version, we do not plan to punish the node).
 
### Time of applications and who should apply?


In general, any node can issue an application message, and such a message would be accepted by the Tangle (assuming it passes rate control). However, we admit that for a low mana node, such behavior does not make much sense. Such nodes can decide not to take part in it. 


For nodes capable of taking part in dRNG we provide a default application algorithm that tells node when to apply. 





A node is said to be $M_\ell$ if, according to its view of mana, it is among top $\ell$ mana nodes. Then nodes produce application messages according to the following: 


If a node $x$ is $M_{2m}$ then it issues an application transaction with a timestamp $T_0-\Delta_A$.


If  for a $k >2$ a node $x$ is $M_{m\cdot k}$ but not $M_{m\cdot (k-1)}$ ($m$ is committee size) then it submits a committee application if before the time $T_0- \Delta_A \frac{\ell-2}{\ell-1}$ there is less than $m$ valid application messages with mana greater then mana of $x$. Node $x$ issues application message with a timestamp $T_0- \Delta_A \frac{\ell-2}{\ell-1}$.



Pseudocode:
```
if (this_node_want_to_participate_in_dRNG) then
	if (time == T_0-Delta_A)
		ell = what_is_my_ell_number(my_ID,MANA_vector)
		CALL APPLICATION_MESSAGE_SEND(ell)
	fi 
fi
```

```
subroutine APPLICATION_MESSAGE_SEND(ell)
	if (ell <= 2) then
		timestamp = T_0-Delta_A
		send_application_message(timestamp) 
	else
		wait_untill(T- Delta_A *(ell-2)/(ell-1))
		CALL what_is_my_mana
		if (number_of_valid_application_messages_with_mana_higher_than_mine < m) then 
			send_application_message(timestamp) 
		fi
	fi
endsubroutine  
```



## 5.3.5.2 Getting committee from mana perception

When enough application messages are in the Tangle, and there is a consensus on top holders' mana, we select  $m$ top mana holders to be in the committee. This approach is straightforward and seems to decrease the probability of malicious node getting into the committee (higher mana is required to be in the committee).




## 5.3.5.3 Message exchange phase - DKG

At the time $t_0, the Tangle does not accept application messages with the timestamps from the application interval. Thus there is an objective criterion for nodes that apply for the committee, and we can select one (pick the top $m$ nodes). 

After that, the message exchange phase begins were newly selected committee members are creating the distributed key. This phase lasts up to $\Delta_C$, and all of the messages are exchanged publically in the Tangle.

If successful, then before $t_0+\Delta_C$ distributed key should be generated. In the case of a malicious behavior/malfunction, a committee may fail to produce a distributed key. This failure can be confirmed at the time of $t_0+\Delta_C+\Delta_{RN}$. Thus at the time $t_0+\Delta_C+\Delta_{RN}$ committee either will be able to produce the first random number of will be able to confirm failure in the DKG phase. 



Assume that a particular node applied to be in a committee and got a seat. If this node refuses to create a distributed key by not exchanging messages, then the committee fails. In the case of committee selection, failure procedure is repeated (see below). The nodes which did not participate in the DKG message exchange are stripped of their dRNG mana (mana used for dRNG committee selection), i.e., this is done by modification of dRNG mana to 0 until next committee is *successfully* selected. Note that we are talking here only about committee mana, mana used for other purposes is unchanged.




## 5.3.5.4 Committee selection failure 


If at time $t_0+\Delta_C+\Delta_{RN}$ failure in the DKG phase is detected, then another attempt of selecting the committee takes place. This time the committee selection time is $t_1 =t_0+\Delta_C+\Delta_{RN}$ and window for application messages is again $\Delta_A$. Nodes produce application messages according to the same rules as for $t_0$. This can be generalised for $k$-th attempt to select the committee at the time $t_k = t_{k-1} + D_{RN} + \Delta_A+\Delta_C)$. In the worst-case scenario of constant DKG failures, the procedure is repeated until the committee update time (time at which committee would be updated in normal circumstances).



## 5.3.5.5 Double seats in the committee 

Our research revealed that if we assign equally important seats in the mana committee, our proposed protocol might be vulnerable for "overtaking" of the committee. An attacker could gain more than $t$ seats in the committee with relatively small mana (about 12% for $m=15$). To reduce this attack vector, we decided to grant double seats for half of the committee with the highest mana. Those nodes would receive two private keys (identities) with which they sign beacon messages in the Tangle. From the technical point of view, two seats are completely separate, and issued messages can not be combined (even though physically signed by the same node). This modification increases mana required to "overtake" the committee. The total number of nodes with double seats equals $\lfloor n/2 \rfloor$ which makes the total number of identities in the committee equal 

$$
n + \lfloor n/2 \rfloor = \left \lfloor 1\frac{1}{2}n \right \rfloor.
$$


## 5.3.5.6 Synching of committee nodes

Before starting random number generations, committee nodes should synch up their clocks, with each other or some other central entity like atomic clock services.



# 5.3.6 Backup options
Although unlikely, it is still possible that the mana committee fails to produce a random number. It can happen when the network is under attack or committee nodes are dealing with technical problems. Even reliable committee members may experience DDOS attacks. Although the threshold-signature scheme has built-in countermeasures for those cases - one needs only $t$ out of $n$ signatures (not all of the committee members are required to publish a secret-revealing message).  We want to make sure that the benefits from a random number (which include increased security) are going to be available even if a large number of committee members are compromised.


As we already pointed out, the random number used in FPC is not an integral part of the consensus mechanism. FPC without random threshold still assures that with reasonable probability, the network will reach a unanimous opinion. However, simulations show that if the nodes use the random threshold, the network is more secure.  It is worth reminding here that there is no requirement for the perfect agreement on the value of the random threshold. It is sufficient for most honest nodes to use the same random threshold to experience the benefits of FPC consensus.  Having that said, we still want the network to utilize more robust FPC security even if the high mana nodes committee fails. To do so, we set up a series of back up the random number generators in the IOTA network (not necessarily decentralized). We plan to use the following sources of random numbers. 





1. **Mana source:** *Committee from high mana nodes*



2. **Community source:** *Pre-selected committee*


3. **Empty source:** *No randomness - random number equals 1/2*





# 5.3.7 Collective beacon 

To recover the random number from beacon messages node needs to perform Lagrange interpolation. Although not very computationally costly, this procedure would need to be completed by each node in the network. 



To avoid that, we propose that committee nodes produce the collective beacon message which contains already computed random number (committee nodes perform Lagrange interpolation on their own). Since the committee size is small and the expected number of TPS for IOTA large, we require all committee members to produce this collective beacon message as soon as they receive $t$ beacon messages.




The cost of getting randomness from collective beacon would be reduced as only the signature verification would be required. 






Non-committee nodes behave as follows: If randomness is required at the time, when no collective beacon is available but more than $t$ beacon messages are published, then the nodes perform Lagrange interpolation themself. 



# 5.3.8 Payload layout

## 5.3.8.1 Application messages

Committee candidature payload
| Field      | Type   | Description                      |
|------------|--------|----------------------------------|
| type       | byte   | message type                     |
| instanceID | uint32 | identifier of the dRAND instance |
| mana       | uint64 | declared mana                    |
| timestamp? | uint64 | timestamp                        |   
TO DISCUSS DURING BERSUM



## 5.3.8.2 DRK generation

Deal payload
| Field      | Type          | Description                      |
|------------|---------------|----------------------------------|
| type       | byte          | message type                     |
| instanceID | uint32        | identifier of the dRAND instance |
| fromIndex  | uint32        | index of the dealer              |
| toIndex    | uint32        | index of the verifier            |
| deal       | encryptedDeal | encrypted share                  |

encryptedDeal struct
| Field          | Type   | Description                                                                   |
|----------------|--------|-------------------------------------------------------------------------------|
| dhkey          | bytes  | ephemereal diffie hellman key                                                 |
| nonce          | bytes  | nonce used in AES-GCM                                                         |
| encryptedShare | bytes  | ciphertext of the share                                                       |
| threshold*     | uint32 | threshold of the secret sharing protocol (decided during committee selection) |
| commitments    | bytes  | commitments of the polynomial used to derive the share                        |


## 5.3.8.3 randomness revealing messages

Beacon payload
| Field            | Type   | Description                                                    |
|------------------|--------|----------------------------------------------------------------|
| type             | byte   | message type                                                   |
| instanceID       | uint32 | identifier of the dRAND instance                               |
| round            | uint64 | round of the current beacon                                    |
| partialPubKey    | bytes  | public key of the issuer                                       |
| partialSignature | bytes  | partial signature of the beacon                                |
<!-- 
| recoverability   | byte   | bit to notify the recoverability of the previous random number | -->

Collective beacon payload
| Field         | Type   | Description                                    |
|---------------|--------|------------------------------------------------|
| type          | byte   | message type                                   |
| instanceID    | uint32 | identifier of the dRAND instance               |
| round         | uint64 | round of the current beacon                    |
| previous      | bytes  | signature of the previous beacon               |
| signature     | bytes  | signature of the new beacon                    |
| distributedPK | bytes  | distributed public key                         |
<!--
| randomness    | bytes  | new randomness (hash of the current signature) |
-->








# 5.3.10 Parameters values

1.  Random number produced every:  $t_{ran}= 10$ $[sec]$

2.  Committee size:   $m= 10$ $[nodes]$

2.  Identities in the committee:   $n= 15$ $[nodes]$

3. drand threshold parameter: $f = 0.51$, $t=8$ $[nodes]$
 
4. Frequency of committee selection:  $Freq. = 1$ $[day]$

5. Time interval for committee ''application'' submission  $\Delta =2$ $[min]$

6. Time delay bound of the dRNG messages: $D_{RN} = 10 [min]$  TO DISCUSS DURING BERSUM!!!




# 5.3.11 Unresolved questions and future improvements
1. Committee failure detection
2. Detection of the random number being unusable
3. Backup committee selection (selection of the new one in case the current one fails before the end of its term)
4. Backup random beacon based on VDFs 


## 5.3.11.1 Research questions
1. How much mana does the attacker need to overtake committee?
2. Probability of false-positive of committee failure detection




<!--stackedit_data:
eyJkaXNjdXNzaW9ucyI6eyJnbUluNFhoZWtvcVpFdGcyIjp7In
RleHQiOiJJZiBhIG5vZGUgc2VuZHMgbW9yZSB0aGFuIG9uZSBh
cHBsaWNhdGlvbiBtZXNzYWdlIHRoZXkgYXJlIHRyZWF0ZWQgYX
MgY29uZmxpY3Rz4oCmIiwic3RhcnQiOjExNDYzLCJlbmQiOjEx
NjMwfSwidkwzakFvR2F1V3RBMDNPNiI6eyJ0ZXh0IjoiU3VjaC
B0cmFuc2FjdGlvbiB3b3VsZCBiZSB1c2VkIHRvIGV4dHJhY3Qg
Km9ubHkqIGEgbWFuYSB2YWx1ZSBvZiBhbiBpc3N1aW5nIG5vZO
KApiIsInN0YXJ0IjoxMDgwMiwiZW5kIjoxMDk4MX0sIjNNZ09O
RjBEcW5lRWdUbmsiOnsidGV4dCI6ImRlY2xhcmVkIG1hbmEgIC
AgICAgICAgICAgICAgICAgIHwiLCJzdGFydCI6MjE2MzQsImVu
ZCI6MjE2MzR9LCIwRG16aGJkbnVybEF1T2NLIjp7InRleHQiOi
JXZSBjYW4gYmUgc3VyZSB0aGF0IGFmdGVyIHRoZSB0aW1lICR0
XzAgLSBcXERlbHRhX0MkIG5vIGFwcGxpY2F0aW9uIG1lc3NhZ2
Ugd2lsbOKApiIsInN0YXJ0IjoxMDQxNCwiZW5kIjoxMDUyMH0s
IjF0cmRwRDV5YlVPNnZreGciOnsidGV4dCI6IlRvIGF2b2lkIH
RoYXQsIHdlIHByb3Bvc2UgdGhhdCBjb21taXR0ZWUgbm9kZXMg
cHJvZHVjZSB0aGUgY29sbGVjdGl2ZSBiZWFjb24gbWXigKYiLC
JzdGFydCI6MjE2MzQsImVuZCI6MjE2MzR9fSwiY29tbWVudHMi
OnsiNEJlYk9XTVl2cnFIMUU4aCI6eyJkaXNjdXNzaW9uSWQiOi
JnbUluNFhoZWtvcVpFdGcyIiwic3ViIjoiZ2g6NTA2NjE4NDQi
LCJ0ZXh0IjoiSG93IGFyZSB0aGV5IHRyZWF0ZWQgbGlrZSBjb2
5mbGljdHM/ICBEbyB3ZSB2b3RlIG9uIHRoZW0/IiwiY3JlYXRl
ZCI6MTU5NjA4OTY2MTU0OX0sImd3MFBnbEFWOWhySUwwSVoiOn
siZGlzY3Vzc2lvbklkIjoiZ21JbjRYaGVrb3FaRXRnMiIsInN1
YiI6ImdoOjUwNjYxODQ0IiwidGV4dCI6IklmIHdlIGhhdmUgdG
8gdm90ZSBvbiB0aGVtLCB0aGVuIHdlIG5lZWQgdG8gYW5hbHl6
ZSB0aGUgc3BhbSBjcmVhdGVkIGJ5IHRoZXNlIHZvdGVzIGFuZC
BpbmNsdWRlIGRldGFpbHMgb24gaG93IHRoZSBvcGluaW9ucyBh
cmUgc2V0IGV0Yy4iLCJjcmVhdGVkIjoxNTk2MDg5NzA4NzYxfS
wiNUJjSXdVMDNtNzBsVGpEQiI6eyJkaXNjdXNzaW9uSWQiOiJ2
TDNqQW9HYXVXdEEwM082Iiwic3ViIjoiZ2g6NTA2NjE4NDQiLC
J0ZXh0IjoiSSB0aGluayB5b3UgbmVlZCB0byBiZSBtb3JlIHNw
ZWNpZmljIGFib3V0IHdoYXQgeW91IGluY2x1ZGUgaW4gaGVyZT
8gIFRoZSBtYW5hIGJhbGFuY2Ugb3IgdGhlIGVmZmVjdGl2ZSBt
YW5hPyIsImNyZWF0ZWQiOjE1OTYwOTAxMzk0ODN9LCJlamN5WU
0yQWdoUE95a3ZwIjp7ImRpc2N1c3Npb25JZCI6IjNNZ09ORjBE
cW5lRWdUbmsiLCJzdWIiOiJnaDo1MDY2MTg0NCIsInRleHQiOi
JUaGlzIG5lZWRzIHRvIGJlIHNwZWNpZmllZC4iLCJjcmVhdGVk
IjoxNTk2MDkwMzkyMjAzfSwiQ1V4dlF1WGlkYjVWZXREOCI6ey
JkaXNjdXNzaW9uSWQiOiIwRG16aGJkbnVybEF1T2NLIiwic3Vi
IjoiZ2g6NTA2NjE4NDQiLCJ0ZXh0IjoiVW5sZXNzIFxcRGVsdG
FfQyBpcyBiaWdnZXIgdGhhbiB3LCB0aGUgdGltZSBzdGFtcCB3
aW5kb3cgcGFyYW1ldGVyLCB0aGlzIGlzIG5vdCB0cnVlLiIsIm
NyZWF0ZWQiOjE1OTYwOTEwOTQ0ODJ9LCJDcDY2NEdMVk1oWk81
Y0hiIjp7ImRpc2N1c3Npb25JZCI6ImdtSW40WGhla29xWkV0Zz
IiLCJzdWIiOiJnaDo1MDY2MTg0NCIsInRleHQiOiJXaHkgbm90
IHRha2UgdGhlIG9uZSB3aXRoIHRoZSBsb3dlciB0aW1lc3RhbX
A/IiwiY3JlYXRlZCI6MTU5NjA5MTE1OTAyOH0sInhGbVhWdmJ4
dUttenA1aEciOnsiZGlzY3Vzc2lvbklkIjoiMXRyZHBENXliVU
82dmt4ZyIsInN1YiI6ImdoOjUwNjYxODQ0IiwidGV4dCI6Ikkg
dGhpbmsgdGhpcyBzcGVjaWZpY2F0aW9uIG92ZXIgYWxsIGxhY2
tzIGRldGFpbC4gIEZvciBpbnN0YW5jZSwgdGhlIGFjdGlvbnMg
aW4gdGhpcyBzZWN0aW9uLCBhbmQgdGhlIGltcGxlbWVudGF0aW
9uIG9mIERSQU5EIG5lZWQgdG8gYmUgZGVzY3JpYmVkIGluIGRl
dGFpbC4iLCJjcmVhdGVkIjoxNTk2MDk0MzE5Mjc4fX0sImhpc3
RvcnkiOlstNjU5NTAxNjE3XX0=
-->