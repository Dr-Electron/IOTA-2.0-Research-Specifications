# 5.3 Decentralised Random Number Generator
  
  
  
The module presented in this specification, allows for the decentralised generation of randomness for the IOTA 2.0 network. The dRNG protocol is divided into three phases. In the first phase, a committee of high mana nodes is selected.  In the second setup phase, the committee members create a collective private key used in the third, beacon phase, where the random numbers are published in the Tangle.  
  
During the committee selection, we do not assume a perfect agreement on the mana values, i.e., different nodes can have slightly different opinions on the mana values of other nodes. Obtaining the consensus on the mana values is the central part of this documentation. In the setup phase, a pair of collective private and public key is created in such a way that no individual committee member knows the entire private key. This is done using $(t,n)$ Distributed Key Generation (DKG), which does not rely on centralized, trusted third parties. In the beacon phase, messages containing random numbers can be signed with the private collective key when at least $t$ of the $n$ committee nodes sign a message with their private key share. All of the random number messages used in three phases are published in the Tangle.  
 
  
  
  
  
  
# 5.3.1 Dependencies  
  
  
1. Mana  
  
2. FPC  
  
3. Autopeering  
  
4. Rate control  
  
  
  
  
  
  
  
  
# 5.3.2 Outline 
  
**1. COMMITTEE SELECTION:**  
  
a) Nodes declare willingness to be a committee member with a special ''application'' message  
  
b) Selection of $n$ top mana holders  
  
  
**2. DKG PHASE:**  
  
Distributed key generation phase. Takes place on the Tangle, participation can be publicly verified.  
  
**3. PUBLICATION PHASE:**  
  
Publication of the beacon messages in the Tangle  
  
  
  
  
  
  
# 5.3.3 Parameters  
  
  
  
  
  
1. The random number production frequency: $t_{ran}$  
  
*Random number is produced every $t_{ran}$ seconds.*  
  
  
  
2. The number of participating nodes: $m, m_2$.  
  
*The committee's size from top mana holders equals $m$; the community committee esnie o bcu ba numbeuau$m_2$.*
  
  
  
3. Committee seat sizes: $n, n_2$  
  
*The number of identities (seats) in the mana committee equals $n$. $n$ does not equal $m$ as specific nodes receive more than one seat, i.e., node publishes more than one beacon message.*  
  
  
  
4. Signature threshold parameter: $f \in [0,1]$ (percentage), $t \in \mathbb{N}$ (number of beacon messages needed to obtain randomness)  
  
*In order to find the next random number, $t$ or more beacon messages are required. $\left ($t =\lfloor nf \rfloor +1 \right )$).*  
  
  
  
5. Frequency of committee update: `Freq`.  
  
*The committee is selected every `Freq` units of time.*  
  
  
  
6. Time window of the ''application'' message submission: $\Delta_A$  
*Nodes at want to be    have to issue a special ''application'' message in the angle within the time window, which lasts for $\Delta_A$   units of time.*  
  
  
  
7. Time delay bound on the dRNG messages: $D_{RN}$  
  
*The network does not accept the dRNG messages with the timestamp off by more than $D_{RN}$ from node's local time. Derived from the protocol specification.*  
  
8. Size of $\mathbb{Z}_{p}$ group: $p$  
  
  
  
# 5.3. Committee selection  
  
  
  
  
To select the  mana committee, we need a consensus on the mana values. Unfortunately, different nodes have different views on mana, due to the slightly different clocks.  
  
The Tangle graph in IOTA 2.0 lacks an obvious 'reference point,' which could be used to calculate mana values. This is not a problem in blockchains where such a reference point could be every $k$-th block; neither it is a problem in IOTA 1.0 where milestones could be such reference. To solve this problem, we use the timestamps of the transactions and use a specific time as a reference point. Application messages are used to determine whether the node wants to participate in the committee, then the committee is formed from the $n$ highest mana holders.  
 
  
## 5.3.5.1 Application messages  
  
  
  
Application messages have to be submitted within a time window of $\Delta_A$ units of time.  
  
In general, any node can issue an application message, and such a message would be accepted by the Tangle (assuming it passes rate control). However, we admit that for a low mana node, such behaviour does not make much sense. Such nodes can decide not to take part in it. Multiple application messages are allowed. However, they are pointless and, in fact, costly as they have to pass the rate control mechanism.  
  
  
  
Assume that the committee should be formed at the time $t_0$. Remember that $D_{RN}$ is bound o accepting dRNG messages in the angle. Then no honest node accepts dRNG message with the timestamp different by more than $D_{RN}$ from its local time.  
Let us denote  
  
$$  
T_0 = t_0 - D_{RN}.  
$$  
  
Then we ee potential committee members to issue an application message in the angle it a timestamp from an interval.  
  
$$  
[T_0 - T_0].  
$$  
  
The Mana value of all nodes would be calculated for the time $T_0$ (reference point).  
  
  
  
For nodes interested in committee participation, e provide a default application algorithm that tells node when to apply. Nodes can modify it; however, we encourage them to stick with it as it reduces the number of exchanged application messages.  
  
  
A node is said to be $M_\ell$ if it is among top $\ell$ top mana nodes (with respect to the time $T_0 -\Delta_A$).  
  
  
  
If a node $x$ is $M_{2m}$ then it issues an application at the time $T_0-\Delta_A$.  
  
  
For $k >2$ and a node $x$ which is $M_{m\cdot k}$ but not $M_{m\cdot (k-1)}$ ($m$ is the committee size) it submits a committee  el ) thetimet  _-Deltasenapplication if before the time $T_0- \Delta_A \frac{\ell-2}{\ell-1}$ there is less than $m$ valid application messages with mana greater then $x$'s mana.  
  
  
  
Pseudocode:  
```  
if (this_node_wants_to_participate_in_dRNG) then  
	if (time == T_0-Delta_A)  
		ell = what_is_my_ell_number(my_ID,MANA_vector)  
		CALL APPLICATION_MESSAGE_SEND(ell)  
	fi  
fi  
```  
  
```  
subroutine APPLICATION_MESSAGE_SEND(ell)  
if (ell <= 2) then  
	timestamp = T_0-Delta_A  
	send_application_message(timestamp)  
else  
	wait_untill(T- Delta_A *(ell-2)/(ell-1))  
	if (number_of_valid_application_messages_with_mana_higher_than_mine < m) then  
		send_application_message(timestamp)  
	fi  
fi  
endsubroutine  
```  
  
  
  
If $m$ or more vared. hoe eses a not e for comtee frmatlid apnesses hd been issued to the Tangle, thenantopta ndhei is considered valid, and the committee is formed from top $m$ mana nodes who applied.  
  
  
  
If committee selectio was a failure, then the procedure should be repeated until success In general if the failed committee selection was supposed to end at time $t_n$ then the procedure is repeated with a new expected ti__aa (imeofiection $t_ __Dei fisuroutine __N{n+_A$  
  
  
  
# 5.3.6 DKG phase  
  
After successful committee selection, confirmed at the time $t_0, the DKG phase starts. In this phase, committee nodes exchange the Deal messages to produce a public/private collective key. Nodes should proceed with DKG message exchange as soon as committee selection is confirmed (time $t_0$).  
  
  
If any committee node refuses to create a collective key pair by not exchanging Deal DKG messages, the DKG phase fails. This can be confirmed at the time of $t_0 + D_{RN}$. Moreover, since the message exchange occurs on the Tangle, everybody can identify nodes that caused the failure. In DKG phase failure, the entire committee selection is repeated. The malicious node can then be excluded from the new committee on process by modifyin mana to zero. This modification is applied only to the mana used in dRNG module. Mana values used for other purposes are unchanged. Moreover, modification is lifted after the committee is *successfully* selected,

i.e., the  committee produces its first beacon messages.  
  
  
If DKG phase failure is confirmed a te time $t_n + D_{RN}$, then the committee selection is repeated with a new expected time of committee selection $t_{n+1} = t_n +2\times D_{RN}+\Delta_A$.  
  
    oe seai  cott 
Our research revealed that we could increase the security of dRNG beacon by granting double seats for half of  with the highest mana. Those nodes would receive two private keys (identities) with which they sign beacon message hange.rethe technical point of view, two seats are entirely separate, and issued messages can not be combined (even though physically signed by the same node). This modification increases mana required to "overtake" the committee, which is understood as gaining $t$ of seats in the committee. Without it, an attacker could gain more than $t$ eat i te committee with about 12% mana for m=15$. With double seat proposal, minimal mana to overtake doubles.  
  
  
The total number of nodes with double seats equals $\lfloor n/2 \rfloor$ which makes the total number of identities in the committee equal  
  
$$  
n + \lfloor n/2 \rfloor = \left \lfloor 1\frac{1}{2}n \right \rfloor.  
$$  
  
  
  
  
  
  
# 5.3.8 Synching of the new committee nodes & duties of the old committee  
  
Before starting random number generations, committee nodes should synch up their clocks, with each other or some other central entity like atomic clock services.  
  
The old committee should stop producing ranom mes onl if the new committee was successfully selected and started producing random numbers. This is confirmed when $t$ or more beacon messages are produced by the new committee and can be read directly from the Tangle.  
  
  
  
# 5.3.9 Community dRNG  
  
Although unlikely, it is still possible that the mana committee fails to produce a random number. To increase liveness of the random number production in the IOTA 2.0, we will deploy multiple dRNG, which uses the same scheme, but the committee is pre-selected from community members. Details of the random number usage from different sources in FPC are described in specification 5.1.  
  
  
In the future, we also want to deploy backup randomness beacon based on VDFs.  
  
  
  
# 5.3.10 Collective beacon message  
  
To recover the random number from beacon messages node needs to perform Lagrange interpolation. Although not very computationally costly, this procedure would need to be ompleted by each node in e  hae idetet the network.  
  
  
  
To avoid that, we propose nodes produce the collective beacon message which contains already computed random number (committee nodes perform Lagrange interpolation on their own). Since the committee size is small and the expected number of TPS for IOTA large, we require all committee members to produce this collective beacon message as soon as they receive $t$ beacon messages. 
  
  
  
  
The cost of getting randomness from collective beacon would be reduced as only the signature verification would be required.  
  
  
  
  
  
  
Non-committee nodes behave as follows: If randomness is requiredtteehen no collective beacon is available but morplan to use than $t$ beacon messages are published, the nodes perform Lagrange interpolation themself.  
  
  
  
# 5.3.11 Payload layout  
  
## Application messages  
  
Committee candidature payload  
| Field | Type | Description |  
|------------|--------|----------------------------------|  
| type | byte | message type |  
| instanceID | uint32 | dentifier of the dRAND instance |  
  
  
  
  
## 5.3.11.2 DRK generation  
  
Deal payload  
| Field | Type | Description |  
|------------|---------------|----------------------------------|  
| type | byte | message type |  
| instanceID | uint32 | identifier of the dRAND instance |  
| fromIndex | uint32 | index of the dealer |  
| toIndex | uint32 | index of the verifier |  
| deal | encryptedDeal | encrypted share |  
  
encryptedDeal struct  
| Field | Type | Description |  
|----------------|--------|-------------------------------------------------------------------------------|  
| dhkey | bytes | ephemereal diffie hellman key |  
| nonce | bytes | nonce used in AES-GCM |  
| encryptedShare | bytes | ciphertext of the share |  
| threshold* | uint32 | threshold of the secret sharing protocol (decided during committee selection) |  
| commitments | bytes | commitments of the polynomial used to derive the share |  
  
  
## 5.3.11.3 andomness revealing messages  
  
Beacon payload  
| Field | Type | Description |  
|------------------|--------|----------------------------------------------------------------|  
| type | byte | message type |  
| instanceID | uint32 | identifier of the dRAND instance |  
| round | uint64 | round of the current beacon |  
| partialPubKey | bytes | public key of the issuer |  
| partialSignature | bytes | partial signature of the beacon |  
  
  
Collective beacon payload  
| Field | Type | Description |  
|---------------|--------|------------------------------------------------|  
| type | byte | message type |  
| instanceID | uint32 | identifier of the dRAND instance |  
| round | uint64 | round of the current beacon |  
| previous | bytes | signature of the pn beacon |  
| signature | bytes | signature of the new beacon |  
| distributedPK | bytes | distributed public key |  
  
  
  
  
  
  
  
 

  Parameters values  
  
1. Random number produced every: $t_{ran}= 10$ $[sec]$  
  
2. Committee size: $m= 10$ $[nodes]$  
  
3. Identities in the committee: $n= 15$ $[nodes]$  
  
4. drand threshold parameter: $f = 0.51$, $t=8$ $[nodes]$  
  
5. Frequency of committee selection: $Freq. = 1$ $[day]$  
  
6. Time interval for committee ''application'' submission $\Delta_A =$ $[min]$  
  
7. Time delay bound of the dRNG messages: $D_{RN} = 2\times w+D = 35 [min]$ ($w,D$ are values of the parameters from spec 4.1 )  
  
  
  
  
   Further research and planned improvements  
  
1. Committee failure detection and recovery mechanism  
  
2. Backup random beacon based on VDFs  
  
3. How much mana does the attacker need to overtake committee and multiple seats in the committee – further research  
  
4. Probability of false-positive of committee failure detection (point 1)
# 5.3 Decentralised Random Number Generator for IOTA network - Specification


This specification is part of IOTA 2.0 [Coordicide](https://coordicide.iota.org/).

The module presented in this specification, decentralized random number generator (dRNG), allows for the decentralized generation of randomness for the IOTA 2.0 network. The dRNG protocol is divided into three phases. In the first phase, a committee of high mana nodes is selected. In the second, setup phase, the selected committee members create a collective private key which is used in the third, beacon phase, where the random numbers are published in the Tangle. 

During the committee selection we do not assume perfect agreement on the mana values  i.ommittee: different nodes can have slightly different opinions on the mana values of other nodes. Obtaining the consensus on the mana values is the main part of this module. In the setup phase, a pair of collective private and public key is created in such a way that no individual committee member knows the entire private key. This is done using $(t,n)$ Distributed Key Generation (DKG), which does not rely on centralized trusted third parties. In the beacon phase messages containing random number can be signed with private collective key when at least $t$ of the $n$ committee nodes sign message with theirs private key share. All of the random number messages used in three phases are published in the Tangle 


In the IOTA 2.0 decentralized random numbers are used in the FPC. Randomness increases the security of this consensus mechanisms by keeping the voting threshold unknown for the potential attacker. We However, FPC can be decoupled from random numbers and the network is not halted if randomness is not produced anymore (although security suffers). Possible usage of dRNG for other modules like autopeering, rate control or smart contract are discussed, although currently we do not plan to deploy them.

To provide the dRNG for IOTA 2.0, we decided to use already existing works, including [Rabin](http://www.sciencedirect.com/science/article/pii/0022000083900429), [Shamir's Secret Sharing](https://en.wikipedia.org/wiki/Shamir%27s_Secret_Sharing); [Petersen secret sharing](https://www.cs.cornell.edu/courses/cs754/2001fa/129.PDF); (Boneh–Lynn–Shacham (BLS) signature scheme)[https://en.wikipedia.org/wiki/Boneh%E2%80%93Lynn%E2%80%93Shacham]; Syta (https://bford.info/pub/dec/random.pdf) and most notably open-source, practical implementation of dRNG: [drand](https://drand.love/). In this specification we use the same cryptographic foundations as drand. Full specification of the drand protocol can be found here: https://github.com/drand/drand. We highly recommend reading it before continuing this specification. In particular the part responsible for [Drand: Cryptographic Background](https://hackmd.io/@nikkolasg/HyUAgm234). It describes both DKG and beacon phases on the cryptographic level. Since we adapted the same threshold scheme we do not repeat this here. 




1 Dependencies


1. Mana

2. FPC

Possibly, in the future:

3. Autopeering

4. Rate control








# 5.3.2 Outline of the decentralized random number generation

**1. COMMITTEE SELECTION:**

a) Nodes declare their willingness to be a committee member with a special ''application'' message

b) Selection of $n$ top mana holders


**2.  DKG PHASE:**

Distributed key generation phase. Takes place on the Ttangle, participation can be publicly verified

**3. PUBLICATION PHASE:**

Publication of the beacon messages in the Tangle 

   





# 5.3.3 Parameters





1. The random number production frequency:  $t_{ran}$

*Random number is produced every $t_{ran}$ seconds.*



2. The number of participating nodes: $m, m_2$.

*The committee's size from top mana holders equals $m$; the size of the community committee (responsible for random backup number) equals $m_2$.*



3. Committee seatizes:   $n, n_2$

*The number of identities (seats) in the high mana committee equals $n$. $n$ does not equal $m$ as  certain nodes receive more than one seats, i.e.: node publishes more than one beacon message.* 



4. Signature threshold parameter: $f \in [0,1]$ (percentage), $t \in \mathbb{N}$ (number of beacon messages needed to obtain randomness)

*In order to find the next random number, $t$ or more beacon messages are required. $\left ($t =\lfloor nf \rfloor +1 \right )$).*



5. Frequency of committee update:  $Freq.$

*The committee is selected every $Freq.$ units of time.*



6. Time window of the ''application'' message submission:  $\Delta_A$
*Nodes that want to be in the committee have to issue a special ''application'' message in the Tangle within the time window, which lasts for $ \Delta_A $ units of time.*



7. Time delay bound on the dRNG messages: $D_{RN}$

*The network does not accept the dRNG messages with the timestamp off by more than $D_{RN}$ from node's local time.*

8. Size of $\mathbb{Z}_{p}$ group: $p$



# 5.3.5 Committee selection




To select the high mana committee, we need a consensus on the mana values. Unfortunately, different nodes have different views on the mana values, due to the slightly different clock. 

The Tangle in IOTA 2.0 lacks an obvious 'reference point' which could be used to calculate mana values. This is not a problem in blockchains where such reference point could be every 1000-th block; neither it is a problem in IOTA 1.0 where milestones could be such reference point. To solve this problem we use the timestamps of the transactions and use specific time as a reference point. Application messages are used to determine weather the node wants to participate in the committee, then the committee is formed from top $n$ highest mana holders.

The committee selection process is analyzed in depth in this article: 
[https://www.overleaf.com/read/jdbhppqyxsvx](https://www.overleaf.com/read/jdbhppqyxsvx) (submitted to the conference, still in revive)

In this article we also describe alternative methods of committee selection and analyze DAG distributed ledgers other than the Tangle. 


## 5.3.5.1 Application messages



Application messages have to submitted within time window of $\Delta_A$ units of time. 

In general, any node can issue an application message, and such a message would be accepted by the Tangle (assuming it passes rate control). However, we admit that for a low mana node, such behavior does not make much sense. Such nodes can decide not to take part in it.  Multiple application messages are allowed. However, they are pointless and in fact rate control costly as they do not bypass rate control. 



Assume that the committee should be formed at the time $t_0$. Remember that $D_{RN}$ is bound on accepting dRNG messages in the Tangle. Then no honest node accepts dRNG message with the timestamp different by more than $D_{RN}$ from its local time.
Let us denote

$$
T_0 = t_0 - D_{RN}.
$$

Then we require the potential committee members to issue an application message in the Tangle with a timestamp from an interval.

$$
[T_0 -\Delta_A, T_0].
$$

Mana value of all of the nodes would be calculated with respect to the time $T_0 -\Delta_A$ (reference point).  



For nodes interested in committee participation we provide a default application algorithm that tells node when to apply. Nodes can modify it, however we encourage them to stick with it as it reduces the number of exchanged application messages.  


A node is said to be $M_\ell$ if at the time $T_0 -\Delta_A$  it is among top $\ell$ top mana nodes. 



If a node $x$ is $M_{2m}$ then it issues an application at the time $T_0-\Delta_A$.


For $k >2$ and a node $x$ which is $M_{m\cdot k}$ but not $M_{m\cdot (k-1)}$ ($m$ is the committee size) it submits a committee application if before the time $T_0- \Delta_A \frac{\ell-2}{\ell-1}$ there is less than $m$ valid application messages with mana greater then $x$'s mana. 



Pseudocode:
```
if (this_node_wants_to_participate_in_dRNG) then
if (time == T_0-Delta_A)
ell = what_is_my_ell_number(my_ID,MANA_vector)
CALL APPLICATION_MESSAGE_SEND(ell)
fi
fi
```

```
subroutine APPLICATION_MESSAGE_SEND(ell)
if (ell <= 2) then
timestamp = T_0-Delta_A
send_application_message(timestamp)
else
wait_untill(T- Delta_A *(ell-2)/(ell-1))
CALL what_is_my_mana
if (number_of_valid_application_messages_with_mana_higher_than_mine < m) then
send_application_message(timestamp)
fi
fi
endsubroutine 
```



If $m$ or more valid application messages had been issued to the Tangle then the committee selection is considered valid and committee is formed from top $m$ mana nodes who applied. 



If committee selection was a failure, then the procedure should be repeated until sucsesfull. In general if the failed committee selection was supposed to be selected at time $t_n$ then the new procedure is repeated  with a new expected time of committee selection $t_{n+1} = t_n + D_{RN}+\Delta_A$



# 5.3.6 DKG phase

After successful committee selection, confirmed at the time $t_0, the DKG phase starts. In this phase committee nodes exchange Deal messages to produce a public/private collective key. Nodes should proceed with DKG message exchange as soon as committee selection is confirmed (time $t_0$). 


If any committee node refuses to create a collective key pair by not exchanging Deal DKG messages, then the DKG phase fails. This can be confirmed at the time $t_0 + D_{RN}$. Moreover, since the message exchange takes place on the Tangle, everybody can identify nodes which caused failure. In the case of DKG phase failure, entire committee selection is repeated. This assures that malicious nodes can be excluded from the committee, by modifying the malicious node's mana to zero. This modification is applied only to the mana used in dRNG module. Mana vaulues used for other purposes is unchanged. Moreover, modification is lifted after the committee is *successfully* selected i.e.: the new committee produces its first beacon messages.


If DKG phase failure is confirmed at the time $t_n + D_{RN}$, then the committee selection is repeated with a new expected time of committee selection $t_{n+1} = t_n +2*D_{RN}+\Delta_A$. 



# 5.3.7 Double seats in the committee

Our research revealed that we can increase the security of dRNG beacon by granting double seats for half of the committee with the highest mana. Those nodes would receive two private keys (identities) with which they sign beacon messages in the Tangle. From the technical point of view, two seats are completely separate, and issued messages can not be combined (even though physically signed by the same node). This modification increases mana required to "overtake" the committee, which is understood as gaining $t$ of seats in the committee. Without it an attacker could gain more than $t$ seats in the committee with about 12% of mana for $m=15$. With double seats proposal, minimal mana to overtake doubles. 


The total number of nodes with double seats equals $\lfloor n/2 \rfloor$ which makes the total number of identities in the committee equal

$$
n + \lfloor n/2 \rfloor = \left \lfloor 1\frac{1}{2}n \right \rfloor.
$$






# 5.3.8 Synching of the new committee nodes & duties of the old committee 

Before starting random number generations, committee nodes should synch up their clocks, with each other or some other central entity like atomic clock services.

Old committee should stop producing random numbers only if the new committee was successfully selected and started producing random numbers. This is confirmed when $t$ or more beacon messages are produced by the new committee and can be read directly from the Tangle.  



# 5.3.9 Community dRNG

Although unlikely, it is still possible that the mana committee fails to produce a random number. To increase livness of random number generator in the IOTA 2.0 we are going to deploy another dRNG which uses the same scheme, but the committee is pre-selected from community members. Details of the random number from different sources in FPC are described in specification 5.1 and 5.2.  


In the future we want to also deploy backup randomness beacon based on VDFs. 



# 5.3.10 Collective beacon message

To recover the random number from beacon messages node needs to perform Lagrange interpolation. Although not very computationally costly, this procedure would need to be completed by each node in the network.



To avoid that, we propose that committee nodes produce the collective beacon message which contains already computed random number (committee nodes perform Lagrange interpolation on their own). Since the committee size is small and the expected number of TPS for IOTA large, we require all committee members to produce this collective beacon message as soon as they receive $t$ beacon messages.




The cost of getting randomness from collective beacon would be reduced as only the signature verification would be required.






Non-committee nodes behave as follows: If randomness is required at the time, when no collective beacon is available but more than $t$ beacon messages are published, then the nodes perform Lagrange interpolation themself.



# 5.3.11 Payload layout

## 5.3.11.1# 5.3 Decentralised Random Number Generator for IOTA network - Specification


This specifiaction is part of [Coordicide](https://coordicide.iota.org/).

The module presented in this specification, decentralized random number generator (dRNG), allows for the decentralized generation of randomness used in the IOTA network. The dRNG protocol is divided into two parts. In the first part, we provide a committee selection method. The committee is selected from the high mana nodes. We do not assume perfect agreement on the mana values  (different nodes can have slightly different opinions on the mana values of other nodes). In the second part, the committee members use a verifiable secret sharing and the threshold signature scheme to produce a random number. An example of such protocol is *drand* where committee members publish *beacon messages* which contain part of the randomness. Those messages are published in the Tangle. In the IOTA 2.0 network, decentralized random numbers are used in the FPC, rate control, and certain autopeering protocols (ar-row). 



# 5.3.1 Introduction


IOTA 2.0 requires a decentralized random number generator (dRNG) to increase the security on the FPC. It can also be used in is the ar-row autopeering protocol (which is currently not used but can be in the future) and can be used in salt-based autopeering (now used). It can also prevent transaction mining in the rate control mechanism. 

To provide the dRNG for IOTA 2.0, we decided to base our work on drand and adapt/develop it to work in the Tangle environment. The DEDIS research group develops drand (currently under: drand organization).  Drand organization currently runs a first test network composed by trustworthy organizations around the globe such as Cloudflare, EPFL, University of Chile and Kudelski Security. The main website of the first launch  is hosted at the league of entropy site: https://leagueofentropy.com


Full specification of the drand protocol can be found here: https://github.com/drand/drand


The IOTA 2.0 protocol's main random number is going to be produced by the committee made from high mana nodes. The top mana nodes proved to be valuable, reliable, and trustworthy for the network. Moreover, such nodes have ''the skin in the game,'' and it would be in their interest to maintain the network's security. Such committee members would be updated periodically. Nevertheless, even those reliable nodes can have certain problems like DDOS attacks or connectivity issues. To improve the reliability of the network, we use a backup, secondary random number beacons. Currently, we plan to use the pre-selected committee of IOTA community nodes as our backup dRNG. 







## 5.3.1.1 Other options: Threshold vs. VDF
Before going directly to the implementation details, we would like to mention other options for dRNG. Although the topic of decentralized randomness production is broad, and multiple choices are available; two schemes are well researched and tested. 

* VDF based
* Threshold signature-based

An example of the first one is RANDAO, which is a smart-contract in the blockchain-based DLTs. It is currently being worked on for the Ethereum 2.0. (for more see: [RANDAO specification](https://github.com/randao/randao)). 



Unsurprisingly, the main component of the VDF based dRNG solutions are VDFs (verifiable delay functions). A VDF  is a function that can only be computed sequentially in a certain number of steps, and incidentally time $ T $, such that anyone can verify it quickly, at most in $O(\log T)$. Valuable property is that the evaluation cannot be parallelized. For more see Introduction to VDF for the IOTA

https://app.slack.com/client/T4D3H4VGT/DJPBCMMGT/thread/CHX06PXPW-1586885304.015400)).



VDF removes the last actor problem by imposing physical time-wall to obtain randomness. 

A brief comparison of VDF and threshold signature-based solutions is provided below.


### VDF:
* Physical limits on predicting randomness (best ASICs)
* Single honest actor makes collusion impossible
* Liveness - after contributing randomness nodes can go offline
* Easy to verify on the users part
* Research on ASICs needed
* Requires actor who calculates VDFs
* Not usable for randomness frequency close to the network delay
 * Who contributes randomness?



### Threshold:

* Used in already deployed ``League of Entropy'' 
* Arbitrarily fast
* Easy to verify on the users part
* Open source code available 
* Setup phase required
* Possible collusion
* No calculations outside of the system required (VDF ASIC)
* Who contributes randomness?
        


VDF based dRNG for IOTA will be developed in the future as another backup option.  






# 5.3.2 Dependencies

The dRNG module depends on the following other modules:

1. Mana (to obtain a list of mana)
2. FPC
3. Autopeering
4. Rate control








# 5.3.3 Outline of the decentralized random number generation

**1. COMMITTEE SELECTION:**

a) Nodes declare their mana with a special ''application'' transaction

b) Selection of $n$ top mana holders 


**2.  DKG PHASE:**

  
Key signing phase on the tangle layer

**3. PUBLICATION PHASE:**

Publication of the dRNG messages  in the Tangle

    




# 5.3.4 Parameters 





1. Random number production frequency:  $t_{ran}$ 
*Random number is produced every $t_{ran}$ seconds.*


2. Number of participating nodes: $m, m_2$. The committee's size from top mana holders equals $m$; the size of the pre-selected committee (responsible for random backup number) equals $m_2$.*

3. Committee sizes:   $n, n_2$
*The number of identities in the committee from top mana holders equals $n$; the number of identities in the pre-selected committee equals $n_2$.* $n$ is not equal to $m$ because certain nodes receive more than one identity, i.e.: node publishes more than one beacon message.  



4. Drand threshold parameter: $f \in [0,1]$ (percentage), $t \in \mathbb{N}$ (number of nodes)
*In order to produce a random number nodes require more or exactly $t$ secret revealing (beacon) messages ($t =\lfloor nf \rfloor +1$).*

 

5. Frequency of committee update:  $Freq.$
*The committee is selected every $Freq.$ units of time.*



6. Time interval of committee ''application'' submission: interval or G phase $\Delta_A$ 
*Nodes that want to be in the committee have to issue a special ''application'' message in the Tangle within the time window, which lasts $ \Delta_A $ units of time.*




7. Time interval of committee communication to obtain distributed key:  $\Delta_C$ 
*The nodes selected to the committee should produce distributed key within $\Delta_C$. units of time*




8. Time delay bound of the dRNG messages: $D_{RN}$
The network does not accept the dRNG messages with the timestamp off by more than $D_{RN}$ from node's local time





























# 5.3.5 Committee selection

The committee selection process is described in more detail in the article: 
https://www.overleaf.com/read/jdbhppqyxsvx


To select the IOTA dRNG committee, we need consensus on the mana values of the top mana holders. However, in the Tangle, unlike in blockchains, there is no perfect consensus on the balances/mana and different nodes can have slightly different mana values. To achieve objective values of mana, we require all of the nodes interested in the committee participation to prepare a special ''application'' transaction, which determines it. Then the committee is formed from top $n$ highest mana holders.


## 5.3.5.1 Fixing mana perception



To obtain the consensus on the mana value of the top nodes, we require them to submit application messages to the Tangle. Application message contains information about their mana.
 


Assume that the committee should be formed at the time $t_0$. Remember that $D_{RN}$ is bound on accepting dRNG messages in the Tangle. Then no honest node accepts dRNG message with the timestamp different by more than $D_{RN}$ from its local time. 
Let us denote 

$$
T_0 = t_0 - D_{RN}.
$$

Then we require the potential committee members to issue an application message in the Tangle with a timestamp from an interval. 

$$
[T_0 -\Delta_A, T_0].
$$

At the time $t_0$ no new application message with a timestamp from $[T_0 -\Delta_A, T_0]$ can be accepted to the Tangle. If such a message would be issued, it should be treated as level 3 bad and not propagated. 


Such transactions would be used to extract *only* a mana value of an issuing node, i.e., manas of two potential committee members will be deduced from different transactions.  Application message contains a timestamp that determines mana value, i.e.: nodes calculate mana using only the transactions with a timestamp smaller or equal to the timestamp if the application transaction.



This method of committee selection has an advantage that only online nodes can apply to be a committee member. Moreover, if a particular node predicts that it will not be able to be a committee member for the entire period (for example, due to the planned maintenance), it can decide not to apply. 


If a node sends more than one application message, all of them are discarded. Those messages are not used for committee formation, and misbehaving nodes can be punished (in this version, we do not plan to punish the node).
 
### Time of applications and who should apply?


In general, any node can issue an application message, and such a message would be accepted by the Tangle (assuming it passes rate control). However, we admit that for a low mana node, such behavior does not make much sense. Such nodes can decide not to take part in it. 


For nodes capable of taking part in dRNG we provide a default application algorithm that tells node when to apply. 





A node is said to be $M_\ell$ if, according to its view of mana, it is among top $\ell$ mana nodes. Then nodes produce application messages according to the following: 


If a node $x$ is $M_{2m}$ then it issues an application transaction with a timestamp $T_0-\Delta_A$.


If  for a $k >2$ a node $x$ is $M_{m\cdot k}$ but not $M_{m\cdot (k-1)}$ ($m$ is committee size) then it submits a committee application if before the time $T_0- \Delta_A \frac{\ell-2}{\ell-1}$ there is less than $m$ valid application messages with mana greater then mana of $x$. Node $x$ issues application message with a timestamp $T_0- \Delta_A \frac{\ell-2}{\ell-1}$.



Pseudocode:
```
if (this_node_wants_to_participate_in_dRNG) then
	if (time == T_0-Delta_A)
		ell = what_is_my_ell_number(my_ID,MANA_vector)
		CALL APPLICATION_MESSAGE_SEND(ell)
	fi 
fi
```

```
subroutine APPLICATION_MESSAGE_SEND(ell)
	if (ell <= 2) then
		timestamp = T_0-Delta_A
		send_application_message(timestamp) 
	else
		wait_untill(T- Delta_A *(ell-2)/(ell-1))
		CALL what_is_my_mana
		if (number_of_valid_application_messages_with_mana_higher_than_mine < m) then 
			send_application_message(timestamp) 
		fi
	fi
endsubroutine  
```



## 5.3.5.2 Getting committee from mana perception

When enough application messages are in the Tangle, and there is a consensus on top holders' mana, we select  $m$ top mana holders to be in the committee. This approach is straightforward and seems to decrease the probability of malicious node getting into the committee (higher mana is required to be in the committee).




## 5.3.5.3 Message exchange phase - DKG

At the time $t_0, the Tangle does not accept application messages with the timestamps from the application interval. Thus there is an objective criterion for nodes that apply for the committee, and we can select one (pick the top $m$ nodes). 

After that, the message exchange phase begins were newly selected committee members are creating the distributed key. This phase lasts up to $\Delta_C$, and all of the messages are exchanged publically in the Tangle.

If successful, then before $t_0+\Delta_C$ distributed key should be generated. In the case of a malicious behavior/malfunction, a committee may fail to produce a distributed key. This failure can be confirmed at the time of $t_0+\Delta_C+\Delta_{RN}$. Thus at the time $t_0+\Delta_C+\Delta_{RN}$ committee either will be able to produce the first random number of will be able to confirm failure in the DKG phase. 



Assume that a particular node applied to be in a committee and got a seat. If this node refuses to create a distributed key by not exchanging messages, then the committee fails. In the case of committee selection, failure procedure is repeated (see below). The nodes which did not participate in the DKG message exchange are stripped of their dRNG mana (mana used for dRNG committee selection), i.e., this is done by modification of dRNG mana to 0 until next committee is *successfully* selected. Note that we are talking here only about committee mana, mana used for other purposes is unchanged.




## 5.3.5.4 Committee selection failure 


If at time $t_0+\Delta_C+\Delta_{RN}$ failure in the DKG phase is detected, then another attempt of selecting the committee takes place. This time the committee selection time is $t_1 =t_0+\Delta_C+\Delta_{RN}$ and window for application messages is again $\Delta_A$. Nodes produce application messages according to the same rules as for $t_0$. This can be generalised for $k$-th attempt to select the committee at the time $t_k = t_{k-1} + D_{RN} + \Delta_A+\Delta_C)$. In the worst-case scenario of constant DKG failures, the procedure is repeated until the committee update time (time at which committee would be updated in normal circumstances).



## 5.3.5.5 Double seats in the committee 

Our research revealed that if we assign equally important seats in the mana committee, our proposed protocol might be vulnerable for "overtaking" of the committee. An attacker could gain more than $t$ seats in the committee with relatively small mana (about 12% for $m=15$). To reduce this attack vector, we decided to grant double seats for half of the committee with the highest mana. Those nodes would receive two private keys (identities) with which they sign beacon messages in the Tangle. From the technical point of view, two seats are completely separate, and issued messages can not be combined (even though physically signed by the same node). This modification increases mana required to "overtake" the committee. The total number of nodes with double seats equals $\lfloor n/2 \rfloor$ which makes the total number of identities in the committee equal 

$$
n + \lfloor n/2 \rfloor = \left \lfloor 1\frac{1}{2}n \right \rfloor.
$$


## 5.3.5.6 Synching of committee nodes

Before starting random number generations, committee nodes should synch up their clocks, with each other or some other central entity like atomic clock services.



# 5.3.6 Backup options
Although unlikely, it is still possible that the mana committee fails to produce a random number. It can happen when the network is under attack or committee nodes are dealing with technical problems. Even reliable committee members may experience DDOS attacks. Although the threshold-signature scheme has built-in countermeasures for those cases - one needs only $t$ out of $n$ signatures (not all of the committee members are required to publish a secret-revealing message).  We want to make sure that the benefits from a random number (which include increased security) are going to be available even if a large number of committee members are compromised.


As we already pointed out, the random number used in FPC is not an integral part of the consensus mechanism. FPC without random threshold still assures that with reasonable probability, the network will reach a unanimous opinion. However, simulations show that if the nodes use the random threshold, the network is more secure.  It is worth reminding here that there is no requirement for the perfect agreement on the value of the random threshold. It is sufficient for most honest nodes to use the same random threshold to experience the benefits of FPC consensus.  Having that said, we still want the network to utilize more robust FPC security even if the high mana nodes committee fails. To do so, we set up a series of back up the random number generators in the IOTA network (not necessarily decentralized). We plan to use the following sources of random numbers. 





1. **Mana source:** *Committee from high mana nodes*



2. **Community source:** *Pre-selected committee*


3. **Empty source:** *No randomness - random number equals 1/2*





# 5.3.7 Collective beacon 

To recover the random number from beacon messages node needs to perform Lagrange interpolation. Although not very computationally costly, this procedure would need to be completed by each node in the network. 



To avoid that, we propose that committee nodes produce the collective beacon message which contains already computed random number (committee nodes perform Lagrange interpolation on their own). Since the committee size is small and the expected number of TPS for IOTA large, we require all committee members to produce this collective beacon message as soon as they receive $t$ beacon messages.




The cost of getting randomness from collective beacon would be reduced as only the signature verification would be required. 






Non-committee nodes behave as follows: If randomness is required at the time, when no collective beacon is available but more than $t$ beacon messages are published, then the nodes perform Lagrange interpolation themself. 



# 5.3.8# Decentralised Random Number Generator for IOTA network - Specification


This specifiaction is part of [Coordicide](https://coordicide.iota.org/).

The module presented in this specification, decentralized random number generator (dRNG), allows for the decentralized generation of randomness used in IOTA network. The dRNG protocol is divided into two parts. In the first part, we provide a committee selection method. The committee is selected from the high mana nodes, however, we do not assume perfect agreement on the mana values (different nodes can have slightly different opinions on the mana values of other nodes). In the second part, the committee members use drand scheme to produce the random number. Drand is based on a combination of verifiable secret sharing scheme and a threshold signature scheme and requires committee members to publish messages with part of the randomness. Those messages are published in the Tangle. In the context of IOTA network, decentralized random numbers are required to FPC consensus mechanism and arrow autopeering (both important for the Coordicide). 





# Introduction


The post-coordinator IOTA network requires a decentralized random number generator (dRNG). Randomness is necessary to increase the security on the FPC. It is also required in the ar-row autopeering protocol and can be used in salt-based autopeering.

In order to provide the dRNG for IOTA network, we decided to use drand scheme, developed by the DEDIS research group (currently under: drand organization). 


The first paragraph from the specification of drand states

> Drand (pronounced ''dee-rand'' is a distributed randomness beacon daemon written in Golang. Servers running drand can be linked with each other to produce collective, publicly verifiable, unbiased, unpredictable random values at fixed intervals using bilinear pairings and threshold cryptography. Drand nodes can also serve locally-generated private randomness to clients.
> 

Full specification of the drand protocol can be found here: https://github.com/drand/drand

Reading further from the specification of drand, its creators claim that drand is

> *  Decentralized: drand is a software ran by a diverse set of reputable entities on the Internet and a threshold of them is needed to generate randomness, there is no central point of failure.
> *  Publicly verifiable & unbiased: drand periodically delivers publicly verifiable and unbiased randomness. Any third party can fetch and verify the authenticity of the randomness and by that making sure it hasn't been tampered with.
> *  And "private" as well: drand nodes can also deliver encrypted randomness to be used in a local applications, for example to seed the OS's PRNG.

Those are the exact properties needed for IOTA dRNG. Another argument in favor of this solution is that it already had been coded, deployed and is currently working providing randomness to the public. Drand organization currently runs a first test network composed by trustworthy organizations around the globe such as Cloudflare, EPFL, University of Chile and Kudelski Security. The main website of the first launch  is hosted at the league of entropy site: https://leagueofentropy.com

The main random number for the IOTA protocol is going to be produced using drand by the committee made from high mana nodes. The high mana nodes proved to be valuable, reliable and trustworthy for the network. Moreover, such nodes have ''the skin in the game'' and it would be in their interest to maintain the security of the network. Such committee members would be updated periodically. Nevertheless, even those reliable nodes can have certain problems like DDOS attacks or connectivity problems. To provide the security of the network even in the case of problems with committee members we equipped our IOTA dRNG proposal with a series of backup options. Backup options are the secondary random number beacons which produce random numbers all the time, however, they are used only if the primary random beacon is not working properly.








## Other options: Threshold vs VDF
Before going directly to the details of the implementation we would like to motivate our choice of a specific method of dRNG. Although the topic of decentralized randomness production is wide and there is a lot of options available, when it comes to well researched and tested proposals there are two ''big players'' in the industry

* VDF based
* Threshold signature-based

An example of the first one is RANDAO which is a smart-contract in the blockchain based DLTs. It is currently being worked on for the Ethereum 2.0. (for more see: [RANDAO specification](https://github.com/randao/randao)). 



Unsurprisingly, the main component of the VDF based dRNG solutions are VDFs (verifiable delay functions). A VDF  is a function which can only be computed sequentially in a certain number of step, and incidentally time $T$, such that anyone can verify it quickly, at most in $O(\log T)$. An important property is that the evaluation cannot be parallelized. To easier fast verification, an evaluator can provide proofs in the output allowing faster verification algorithms while keeping the whole process safe (from [Introduction to VDF for the IOTA](https://app.slack.com/client/T4D3H4VGT/DJPBCMMGT/thread/CHX06PXPW-1586885304.015400)).



VDF can be used to provide a physical time wall on the revealing part of the commit-reveal scheme. Which normally suffers from the last actor problem.

A brief comparison of VDF and threshold signature-based solutions is provided below.


### VDF:
* Physical limits on predicting randomness (best ASICs)
* Single honest actor makes collusion impossible
* Liveness - after contributing randomness nodes can go offline
* Easy to verify on the users part
* Research on ASICs needed
* Requires actor who calculates VDFs
* Not usable for randomness frequency close to the network delay
 * Who contributes randomness?



### Threshold:

* Used in already deployed ``League of Entropy'' 
* Arbitrarily fast
* Easy to verify on the users part
* Open source code available 
* Setup phase required
* Possible collusion
* No calculations outside of the system required (VDF ASIC)
* Who contributes randomness?
        









# Dependencies

The dRNG module depends on the following other modules:

1. Mana (to obtain list of mana)
2. FPC
3. Autopeering








# Outline of the decentralized random number generation


1. Nodes declaring (and proving) their own mana with special ''application'' transaction
2. Selection of $n$ top mana holders to the committee 
3. Key signing phase on the tangle layer
4. Publication of the dRNG messages  in the Tangle

    




# Parameters 





1. Random number production frequency:  $t_{ran}$ 
*Random number is produced every $t_{ran}$ seconds.*


2. Number of participating nodes: $m, m_2$
*The size of the committee from top mana holders equals $m$; the size of the pre-selected committee (responsible for backup random number) equals $m_2$. $m,m_2$ are not necessarily the same as the number of identities that participate in the production of the random number as certain nodes can hold more than one seat in the committee.*


3. Committee sizes:   $n, n_2$
*The number of identities in the committee from top mana holders equals $n$; the number of identities in the pre-selected committee (responsible for backup random number) equals $n_2$.*



4. Drand threshold parameter: $f \in [0,1]$ (percentage), $t \in \mathbb{N}$ (number of nodes)
*In order to produce a random number nodes require more or exactly $t$ secret revealing (beacon) messages ($t =\lceil nf \rceil$).*

 

5. Frequency of committee update:  $Freq.$
*The committee is selected every $Freq.$ units of time.*



6. Time interval of committee ''application'' submission:  $\Delta_A$ 
*Nodes which want to be in the committee have to issue a special ''application'' message in the tangle within time window which lasts $\Delta_A$ units of time.*




7. Time interval of committee communication to obtain distributed key:  $\Delta_C$ 
*The nodes which had been selected to the committee exchange messages to obtain distributed key within $\Delta_C$.*




<!---  6.  Number of nodes submitting ''applications'':  $n^*_{1}, n^*_{2}$

  *$n^*_{1}$ is the number of nodes that issue the ''application'' message within the first $\Delta/2$ units of time.  $n^*_{2}$ is the number of nodes which issue ''application'' message in $\left [\frac{1}{2}\Delta;\frac{3}{4} \Delta\right ]$ units of time if not enough applications had been issued within first $\Delta/2$ units of time.*




8.  The threshold for detecting unusable random number:  $\tau$

*If more than $\tau$ percentage of secret revealing messages include $Rec.=0$ then the random number is considered to be unusable.*



9. The threshold for detecting a failure of the unusable random number for a number of rounds in the row: $\rho$

*If the random number is unusable for $\rho$ random numbers in the row then the new committee selection procedure is started.*

-->


8. Time delay bound of the dRNG messages: $D_{RN}$
The network does not accept the dRNG messages with the timestamp off by more than $D_{RN}$ from node's local time





























# Committee selection



To select the IOTA dRNG committee we acquire the consensus on the mana values of the high mana holders (remember that there is no perfect consensus on the mana values and different nodes can have slightly different values of mana). We require all of the nodes interested in the committee participation to prepare a special ''application'' transaction which determines the value of mana of a given node. Then the committee is formed from top $n$ highest mana holders.


## Fixing mana perception



To obtain the consensus on the mana value of the top nodes we require them to submit special application messages to the tangle with information about their mana.
 


Assume that the committee should be formed at the time $t_0$. Remember that $D_{RN}$ is bound of accepting dRNG messages in the tangle. Then no honest node will accept dRNG message with the timestamp different by more than $D_{RN}$ from its local time. 
Lets denote 
$$
T_0 = t_0 - \Delta_C - D_{RN}.
$$
Then we require the potential committee members to issue an application message in the Tangle with a timestamp  from an interval 
$$
[T_0 -\Delta_A, T_0].
$$
We can be sure that after the time $t_0 - \Delta_C$ no application message will be accepted in the Tangle. 

> [name=Sebastian Mueller] "We can be sure.." this formulation is not correct. Moreover the protocol needs a rule how to treat the event when it occurs. Also the formulation in 8. above is too strong, since local clocks differ and we need consensus on local times to have this.

Such transaction would be used to extract *only* a mana value of an issuing node i.e.: manas of two potential committee members are going to be deduced from different transactions. 



In order to deduce mana value from the transaction, we calculate mana using only the transactions with a timestamp smaller or equal to the timestamp if the application transaction.



This method of committee selection has an advantage that only online nodes can apply to be a committee member. Also, if a certain node predicts that it will not be able to be a committee member for the entire period (for example due to the planned maintenance) it can decide not to apply. 


If a node sends more than one application message they are treated as conflicts. Such behavior can be later punished (this action is not relevant for dRNG protocol).
> [name=Sebastian Mueller] Or, if there are more than two applications messages, all applications are dropped and the node is not considered for the committee. In case of conflicts, we would have to vote.

 
### Time of applications and who should apply?


In general, any node can issue an application message and such a message would be accepted by the tangle (assuming it passes rate control). However,  we admit that for a low mana node such behavior does not make much sense. We provide a default application algorithm that tells node when to apply. 





A node is said to be $M_\ell$ if according to its own view of mana it is among top $\ell$ mana nodes. 



Then nodes produce application messages according to the following: 


If a node $x$ is $M_{2m}$ then it issues an application transaction with a timestamp $T-\Delta_A$.


If  for a $k >2$ a node $x$ is $M_{m\cdot k}$ but not $M_{m\cdot (k-1)}$ ($m$ is committee size) then it submits a committee application if before the time $T- \Delta_A \frac{\ell-2}{\ell-1}$ there is less than $m$ valid application messages with mana greater then mana of $x$. Node $x$ issues application message with a timestamp $T- \Delta_A \frac{\ell-2}{\ell-1}$.

> [name=Sebastian Mueller] For small nodes, it may be useful to have a flag indicating that a node does not participate at all. In this case this node does not have to "listen" to all of this committee selection thing.

<!--
A node $x$ has a (subjective) list of mana of all of the nodes. After ordering it, the node knows what is its position on this list. Let's name denote this position by $x_m$.



We divide all of the nodes into three groups:

*a)* $x_m \geq n^*_1$ 

*b)* $n^*_1> x_m \geq n^*_2$

*c)* $n^*_{2} >x_m$ 



Dependent on what group node is in node takes different actions. 
Group *a)* produces application message within time interval $[ t_0 - 2D_{RN} -\Delta; t_0 - 2D_{RN}-\Delta/2]$.


Group *b)* checks wheather at time $t_0 - 2D_{RN}-\Delta/2$ (according to its local clock) the number of committee applications which state that node's mana is higher than $x_m$ is larger than $n$. If yes then node do nothing. If no it publishes application with a timestamp from an interval $\left [ t_0 - 2D_{RN} -\Delta/2; t_0 - 2D_{RN}-\frac{3}{4}\Delta \right ]$.
 

Group *c)* checks wheather at time $t_0 - 2D_{RN}-\frac{3}{4}\Delta$ (according to its local clock) number of committee applications which state that node's mana is higher than of $x_m$ is greater than $n$. If yes then node do nothing. If no it publishes application with a timestamp from an interval $\left [ t_0 - 2D_{RN} -\frac{3}{4}\Delta; t_0 - 2D_{RN}-\Delta \right ]$.



So, in other words, top $n^*_1$ nodes issue application transaction within $\Delta/2$ time window. After that, if not enough applications had been submitted another $n^*_2$ are issued by the time $\frac{3}{4}\Delta$. If after that still not enough messages had been issued every active node tries to issue an application. 

-->

## Getting committee from mana perception

When enough applications are in the tangle and there is a consensus on the mana of top holders, we select  $n$ top mana holders to be in the committee. This approach is straightforward and seems to decrease the probability of malicious node getting into the committee (higher mana is required to be in the committee).




## Message exchange phase - DKG

At the time $t_0 - \Delta_C$ the Tangle does not accept application messages with the timestamps from the application interval. Thus there is an objective criterion for nodes that apply for the committee and we can select one (pick the top $m$ nodes). 

Just after that, the message exchange phase begins were newly selected committee members are creating the distributed key. This phase lasts up to $\Delta_C$ and all of the messages are exchanged publically in the Tangle.

If successful, then before $t_0$ distributed key should be generated and the first random number should be produced at $t_0$. 

Assume that a certain node applied to be in a committee and got a seat. If this node refuses to create a distributed key by not exchanging messages, then the committee fails. In the case of committee selection, failure procedure is repeated at time $t_1,t_2,...$ (described below) and the node which did not place the messages in the tangle is refused to participate in the next committee selection. This is done by modification of its (committee) mana to 0 until next committee is *successfully* selected. Note that we are talking here only about committee mana, mana used for other purposes is unchanged.

> [name=Sebastian Mueller] But for this to work we would need consensus on who refused/was not able to participate. Say if adversary just sends its distributed key with correct timestamps, such that half of the network sees it in time but the other half too late. This consensus may be done by the message layer in case $D_{RN}$ equals the $D$(?) there, otherwise, a FPC must be done. 




## Committee selection failure 


If at time $t_0$ there will be no randomness produced (which can be confirmed only at the time $t_0+D_{RN}$) then another attempt of selecting committee takes place. This time the committee selection time is $t_1 =t_0 +2D_{RN}+\Delta_A+\Delta_C$ and window for application messages is still $\Delta_A$. Nodes produce application messages according to the same rules as for $t_0$. This can be generalised for $k$-th attempt to select the committee at the time $t_k = t_0 + D_{RN}+ k(D_{RN} + \Delta_A+\Delta_C)$. 



## Double seats in the committee 
Note that in the original drand protocol all of the seats in the committee are equivalent and no node is more important than the others. 



Our research revealed that if we follow the same method of assigning seats in the mana committee then our proposed protocol might be vulnerable for "overtaking" the committee. An attacker could gain more than $t$ seats in the committee with relatively small mana (about 6% for $n=15$). To reduce this attack vector we decided to grant double seats for half of the committee with the highest mana (we assume that highest mana nodes are honest). Those nodes would receive two private keys (identities) with which they sign beacon messages in the Tangle. From the technical point of view, two seats are completely separate and issued messages can not be combined (even though physically signed by the same node). This increases mana required to "overtake" the committee. The total number of nodes with double seats equals $\lfloor n/2 \rfloor$ which makes the total number of identities in the committee equal 

$$
n + \lfloor n/2 \rfloor = \left \lfloor 1\frac{1}{2}n \right \rfloor.
$$


## Synching of committee nodes

Before starting random number generations committee nodes should synch up theirs clocks, with each other or some other central entitiy like atomic clock services.



# Backup options
Although unlikely it is still possible that the mana committee fails to produce a random number. It can happen when the network is under attack or committee nodes are dealing with technical problems. Even reliable committee members can have certain problems like DDOS attacks. They can be hacked or compromised in other unexpected ways. Although drand has built-in certain countermeasures for those cases - one needs only $t$ out of $n$ signatures (not all of the committee members are required to publish a secret-revealing message).  We want to make sure that the benefits that come from a random number (which include increased security) are going to be available even if a large number of committee members are compromised.


As we already pointed out the random number used in FPC is not an inseparable part of the consensus mechanism. FPC without random threshold still assures that with reasonable probability the network will reach a unanimous opinion. However, as simulations show if the nodes in the network use the random threshold then the network is more secure - the smaller probability of fork.  What is worth reminding here is that there is no requirement for the perfect agreement on the value of the random threshold. It is sufficient for the majority of the honest nodes to use the same random threshold to use the full benefits of FPC consensus.  Having that said we still want the network to utilize stronger security of FPC even if the high mana nodes committee fails. To do so we set up a series of back up the random number generators in the IOTA network (not necessarily decentralized). We order them according to the measure of decentralization from the most decentralized to the most centralized. The rule is that if a node has available multiple random numbers it always picks the highest quality random number. We divide our backup random number beacons into the ''sources''.



We have the following sources of random numbers 





1. **Mana source:** *Committee from high mana nodes*



2. **Community source:** *Pre-selected committee*

3. **IF source:** *IOTA Foundation (''coordinator'') random number*

4. **Empty source:** *No randomness - random number equals 1/2*





The first and second sources are the committee based. In both cases, the committee uses drand to produce random numbers, the secret-revealing messages are published in the Tangle. The second source committee is going to be pre-selected and hardcoded into the client. The committee members are going to be selected by IOTA Foundation. The second instance committee members can be: *a)* IOTA Foundation business partners, *b)* Active committee members. Or a combination of both. 



The third instance random number is going to be produced by the specialized IOTA Foundation owned node which publishes pseudo-random numbers in the Tangle.



If all of the previous options fail, nodes that want to perform FPC voting should use $\beta = 1/2$ in theirs FPC voting (a random number equal to 1/2). 


Let us stress that in the case if a certain small group of honest nodes use the  lower quality source of randomness then still the FPC consensus can experience benefits of random threshold.



# Collective beacon 

To recover the random number from beacon messages node needs to perform Lagrange interpolation. This procedure although not very computationally costly would need to be performed by each node in the network. 



To avoid that, we propose that committee nodes produce the collective beacon message which contains already computed random number (committee nodes perform Lagrange interpolation on their own). Since the committee size is small and the expected number of TPS for post coordicade IOTA is in orders of thousands we require all of the committee members to produce this collective beacon message. 







The cost of getting randomness from collective beacon would be reduced as only the signature verification would be required. 







If at the time when randomness is required there is no collective beacon in the Tangle but there are enough beacon messages then the nodes perform Lagrange interpolation themselves. 
# Payload layout

## 5.3.8.1 Application messages

Committee candidature payload
| Field      | Type   | Description                      |
|------------|--------|----------------------------------|
| type       | byte   | message type                     |
| instanceID | uint32 | identifier of the dRAND instance |




## 5.3.11.2| mana       | uint64 | declared mana                    |
| timestamp? | uint64 | timestamp                        |   
TO DISCUSS DURING BERSUM| mana       | uint64 | declared mana                    |



##



## 5.3.8.2 DRK generation

Deal payload
| Field      | Type          | Description                      |
|------------|---------------|----------------------------------|
| type       | byte          | message type                     |
| instanceID | uint32        | identifier of the dRAND instance |
| fromIndex  | uint32        | index of the dealer              |
| toIndex    | uint32        | index of the verifier            |
| deal       | encryptedDeal | encrypted share                  |

encryptedDeal struct
| Field          | Type   | Description                                                                   |
|----------------|--------|-------------------------------------------------------------------------------|
| dhkey          | bytes  | ephemereal diffie hellman key                                                 |
| nonce          | bytes  | nonce used in AES-GCM                                                         |
| encryptedShare | bytes  | ciphertext of the share                                                       |
| threshold*     | uint32 | threshold of the secret sharing protocol (decided during committee selection) |
| commitments    | bytes  | commitments of the polynomial used to derive the share                        |


## 5.3.118.3 RrRrandomness revealing messages

Beacon payload
| Field            | Type   | Description                                                    |
|------------------|--------|----------------------------------------------------------------|
| type             | byte   | message type                                                   |
| instanceID       | uint32 | identifier of the dRAND instance                               |
| round            | uint64 | round of the current beacon                                    |
| partialPubKey    | bytes  | public key of the issuer                                       |
| partialSignature | bytes  | partial signature of the beacon                                |

<!-- 
| recoverability   | byte   | bit to notify the recoverability of the previous random number | -->

Collective beacon payload
| Field         | Type   | Description                                    |
|---------------|--------|------------------------------------------------|
| type          | byte   | message type                                   |
| instanceID    | uint32 | identifier of the dRAND instance               |
| round         | uint64 | round of the current beacon                    |
| previous      | bytes  | signature of the previous beacon               |
| signature     | bytes  | signature of the new beacon                    |
| distributedPK | bytes  | distributed public key                         |









# 5.3.120 Parameters values

1.  Random number produced every:  $t_{ran}= 10$ $[sec]$

2.  Committee size:   $m= 10$ $[nodes]$

3.  Identities in the committee:   $n= 15$ $[nodes]$

4. drand threshold parameter: $f = 0.51$, $t=8$ $[nodes]$
 
5. Frequency of committee selection:  $Freq. = 1$ $[day]$

6. Time interval for committee ''application'' submission  $\Delta_A =4$ $[min]$

7. Time delay bound of the dRNG messages: $D_{RN} = 2*w+D = 35 [min]$ ($w,D$ are values of the parameters from XXX)






## 5.3.13 Further research and planned improvements 

1. Committee failure detection and recovery mechanism

2. Backup random beacon based on VDFs

3. How much mana does the attacker need to overtake committee and multiple seats in the committee – further research

4. Probability of false-positive of committee failure detection (point 1)interval for DKG phase $\Delta_C =$ $[min]$

8. Time delay bound of the dRNG messages: $D_{RN} = w = 10 [min]$  TO DISCUSS DURING BERSUM!!!

<!--
| randomness    | bytes  | new randomness (hash of the current signature) |
-->




<!--
# Committee failure and RN recoverability



We designed our dRNG messages in such a way that the secret-revealing, beacon messages contain an additional bit of information called `Rec.` (recoverability). The value of this bit is `0` if in the last round given nodes was able to recover the RN from the messages issued by other committee members i.e.: whether the node received at least `t` beacon messages in time (Value of `Rec.` can be also set to zero based on other premises. For example when the node knows that some of the committee members were compromised.


If the committee failed and stopped producing RN then all of the other nodes in the network use lower instance RN, while the committee takes appropriate actions. Active and honest committee members drop out of the current committee and apply for the membership in the new one. 





Committee member deduces that in the last round the committee failed to produce random number if more than `tau` fraction of the beacon messages contain `Rec. = 0`. The trigger for dropping out of the committee is a situation in which node deduces that the RN was not produced for `rho` rounds in a row. Note that in the environment of the committee failure, when nodes receive less than `tau` fraction of the messages it is not feasible to run any consensus mechanism (like pBFT) as all of them can withstand up to the `1/3` of faulty nodes. 


-->






# Parameters values

1.  Random number produced every:  $t_{ran}= 10$ $[sec]$

2.  C<!--
| randomness    | bytes  | new randomness (hash of the current signature) |
-->








# 5.3.10 Parameters values

1.  Random number produced every:  $t_{ran}= 10$ $[sec]$

2.  Committee size:   $m= 10$ $[nodes]$

2.  Identities in the committee size:   $n= 15$ $[nodes]$

3. drand threshold parameter: $f = 0.51$, $t=8$ $[nodes]$
 
4. Frequency of committee selection:  $Freq. = 1$ $[day]$

5. Time interval for committee ''application'' submission  $\Delta =102$ $[min]$

6. Time delay bound of the dRNG messages: $D_{RN} = 10 [min]$ 




# TO DISCUSS DURING BERSUM!!!




# 5.3.11 Unresolved questions and future improvements
1. Committee failure detection
2. Detection of the random number being unusable
3. Backup committee selection (selection of the new one in case the current one fails before the end of its term)
4. Backup random beacon based on VDFs 




## 5.3.11.1 Research questions
1. How much mana does the attacker need to overtake committee?
2. Probability of false-positive of committee failure detection






<!--stackedit_data:
eyJkaXNjdXNzaW9ucyI6eyJnbUluNFhoZWtvcVpFdGcyIjp7In
RleHQiOiJJZiBhIG5vZGUgc2VuZHMgbW9yZSB0aGFuIG9uZSBh
cHBsaWNhdGlvbiBtZXNzYWdlIHRoZXkgYXJlIHRyZWF0ZWQgYX
MgY29uZmxpY3Rz4oCmIiwic3RhcnQiOjU2MzA2LCJlbmQiOjU2
NDczfSwidkwzakFvR2F1V3RBMDNPNiI6eyJ0ZXh0IjoiU3VjaC
B0cmFuc2FjdGlvbiB3b3VsZCBiZSB1c2VkIHRvIGV4dHJhY3Qg
Km9ubHkqIGEgbWFuYSB2YWx1ZSBvZiBhbiBpc3N1aW5nIG5vZO
KApiIsInN0YXJ0Ijo1NTY0NSwiZW5kIjo1NTgyNH0sIjNNZ09O
RjBEcW5lRWdUbmsiOnsidGV4dCI6ImRlY2xhcmVkIG1hbmEgIC
AgICAgICAgICAgICAgICAgIHwiLCJzdGFydCI6NzQ1NDcsImVu
ZCI6NzQ1NDd9LCIwRG16aGJkbnVybEF1T2NLIjp7InRleHQiOi
JXZSBjYW4gYmUgc3VyZSB0aGF0IGFmdGVyIHRoZSB0aW1lICR0
XzAgLSBcXERlbHRhX0MkIG5vIGFwcGxpY2F0aW9uIG1lc3NhZ2
Ugd2lsbOKApiIsInN0YXJ0Ijo1NTI1NywiZW5kIjo1NTM2M30s
IjF0cmRwRDV5YlVPNnZreGciOnsidGV4dCI6IlRvIGF2b2lkIH
RoYXQsIHdlIHByb3Bvc2UgdGhhdCBjb21taXR0ZWUgbm9kZXMg
cHJvZHVjZSB0aGUgY29sbGVjdGl2ZSBiZWFjb24gbWXigKYiLC
JzdGFydCI6NzQ1NDcsImVuZCI6NzQ1NDd9LCIxeU5NQzF6Nngy
NVpvdDZMIjp7InRleHQiOiJUaGlzIHNwZWNpZmljY3Rpb24gaX
MgcGFydCBvZiBJT1RBIDIuMCBbQ29vcmRpY2lkZV0oaHR0cHM6
Ly9jb29yZGljaWRlLmlvdGEub3Jn4oCmIiwic3RhcnQiOjE0Mj
IwLCJlbmQiOjE0MjIwfSwiVFVNVDNVeVNZeWRYUXpDSCI6eyJ0
ZXh0IjoiSU9UQSAyLjAgcmVxdWlyZXMgYSBkZWNlbnRyYWxpem
VkIHJhbmRvbSBudW1iZXIgZ2VuZXJhdG9yIChkUm90IGFzc3Vl
IHBlcmZlY3QgYeKApiIsInN0YXJ0IjoxNDIyMCwiZW5kIjoxND
IyMH0sInBFdlY3UTM2WHM1aW1zZGQiOnsic3RhcnQiOjEzMzQs
ImVuZCI6MTM1MCwidGV4dCI6Ik1hbmEgIFxuICBcbjIuIEZQQy
J9LCJCM1c2QXBNWUV3NlN5dlJxIjp7InN0YXJ0IjoxNzQzLCJl
bmQiOjE3NTksInRleHQiOiIqKjMuIFBVQkxJQ0FUSU9OIn0sIk
hQNHpkeU5EeXhReEFacHIiOnsic3RhcnQiOjIxMzQsImVuZCI6
MjE2MywidGV4dCI6ImVzbmllIG8gYmN1IGJhIG51bWJldWF1JG
1fMiQuIn0sImxFNE5qVXlNY3lPVlNhSlEiOnsic3RhcnQiOjIx
NzcsImVuZCI6MjIwNywidGV4dCI6IkNvbW1pdHRlZSBzZWF0IH
NpemVzOiAkbiwgbl8yJCJ9fSwiY29tbWVudHMiOnsiNEJlYk9X
TVl2cnFIMUU4aCI6eyJkaXNjdXNzaW9uSWQiOiJnbUluNFhoZW
tvcVpFdGcyIiwic3ViIjoiZ2g6NTA2NjE4NDQiLCJ0ZXh0Ijoi
SG93IGFyZSB0aGV5IHRyZWF0ZWQgbGlrZSBjb25mbGljdHM/IC
BEbyB3ZSB2b3RlIG9uIHRoZW0/IiwiY3JlYXRlZCI6MTU5NjA4
OTY2MTU0OX0sImd3MFBnbEFWOWhySUwwSVoiOnsiZGlzY3Vzc2
lvbklkIjoiZ21JbjRYaGVrb3FaRXRnMiIsInN1YiI6ImdoOjUw
NjYxODQ0IiwidGV4dCI6IklmIHdlIGhhdmUgdG8gdm90ZSBvbi
B0aGVtLCB0aGVuIHdlIG5lZWQgdG8gYW5hbHl6ZSB0aGUgc3Bh
bSBjcmVhdGVkIGJ5IHRoZXNlIHZvdGVzIGFuZCBpbmNsdWRlIG
RldGFpbHMgb24gaG93IHRoZSBvcGluaW9ucyBhcmUgc2V0IGV0
Yy4iLCJjcmVhdGVkIjoxNTk2MDg5NzA4NzYxfSwiNUJjSXdVMD
NtNzBsVGpEQiI6eyJkaXNjdXNzaW9uSWQiOiJ2TDNqQW9HYXVX
dEEwM082Iiwic3ViIjoiZ2g6NTA2NjE4NDQiLCJ0ZXh0IjoiSS
B0aGluayB5b3UgbmVlZCB0byBiZSBtb3JlIHNwZWNpZmljIGFi
b3V0IHdoYXQgeW91IGluY2x1ZGUgaW4gaGVyZT8gIFRoZSBtYW
5hIGJhbGFuY2Ugb3IgdGhlIGVmZmVjdGl2ZSBtYW5hPyIsImNy
ZWF0ZWQiOjE1OTYwOTAxMzk0ODN9LCJlamN5WU0yQWdoUE95a3
ZwIjp7ImRpc2N1c3Npb25JZCI6IjNNZ09ORjBEcW5lRWdUbmsi
LCJzdWIiOiJnaDo1MDY2MTg0NCIsInRleHQiOiJUaGlzIG5lZW
RzIHRvIGJlIHNwZWNpZmllZC4iLCJjcmVhdGVkIjoxNTk2MDkw
MzkyMjAzfSwiQ1V4dlF1WGlkYjVWZXREOCI6eyJkaXNjdXNzaW
9uSWQiOiIwRG16aGJkbnVybEF1T2NLIiwic3ViIjoiZ2g6NTA2
NjE4NDQiLCJ0ZXh0IjoiVW5sZXNzIFxcRGVsdGFfQyBpcyBiaW
dnZXIgdGhhbiB3LCB0aGUgdGltZSBzdGFtcCB3aW5kb3cgcGFy
YW1ldGVyLCB0aGlzIGlzIG5vdCB0cnVlLiIsImNyZWF0ZWQiOj
E1OTYwOTEwOTQ0ODJ9LCJDcDY2NEdMVk1oWk81Y0hiIjp7ImRp
c2N1c3Npb25JZCI6ImdtSW40WGhla29xWkV0ZzIiLCJzdWIiOi
JnaDo1MDY2MTg0NCIsInRleHQiOiJXaHkgbm90IHRha2UgdGhl
IG9uZSB3aXRoIHRoZSBsb3dlciB0aW1lc3RhbXA/IiwiY3JlYX
RlZCI6MTU5NjA5MTE1OTAyOH0sInhGbVhWdmJ4dUttenA1aEci
OnsiZGlzY3Vzc2lvbklkIjoiMXRyZHBENXliVU82dmt4ZyIsIn
N1YiI6ImdoOjUwNjYxODQ0IiwidGV4dCI6IkkgdGhpbmsgdGhp
cyBzcGVjaWZpY2F0aW9uIG92ZXIgYWxsIGxhY2tzIGRldGFpbC
4gIEZvciBpbnN0YW5jZSwgdGhlIGFjdGlvbnMgaW4gdGhpcyBz
ZWN0aW9uLCBhbmQgdGhlIGltcGxlbWVudGF0aW9uIG9mIERSQU
5EIG5lZWQgdG8gYmUgZGVzY3JpYmVkIGluIGRldGFpbC4iLCJj
cmVhdGVkIjoxNTk2MDk0MzE5Mjc4fSwieEJNakxOWExYTEV4S1
IwOSI6eyJkaXNjdXNzaW9uSWQiOiIxeU5NQzF6NngyNVpvdDZM
Iiwic3ViIjoiZ2g6NjgyNTAzNTAiLCJ0ZXh0IjoiU29tZSBwcm
9ibGVtIGhhcHBlbmVkIG9uIHN5bmNocm9uaXphdGlvbiBhbmQg
dGhlIGZpbGUgYmVjYW1lIGEgbGl0dGxlIG1lc3N5LiBOZWVkIH
RvIHNvbHZlIiwiY3JlYXRlZCI6MTU5NzgwMTM0NzY3NH0sIjZa
YW1qTEtpd05jRTh3Y3ciOnsiZGlzY3Vzc2lvbklkIjoiVFVNVD
NVeVNZeWRYUXpDSCIsInN1YiI6ImdoOjY4MjUwMzUwIiwidGV4
dCI6IlNhbWUgYXMgYWJvdmUiLCJjcmVhdGVkIjoxNTk3ODAxMz
k0NTAxfSwiUUJCNllqUkZlV3Y2VkRTTiI6eyJkaXNjdXNzaW9u
SWQiOiJwRXZWN1EzNlhzNWltc2RkIiwic3ViIjoiZ2g6NjgyNT
AzNTAiLCJ0ZXh0IjoiRGVzY3JpcHRpb25zIG9uIGhvdyBvciB3
aGVyZSBpdCBpcyB1c2VkIiwiY3JlYXRlZCI6MTU5ODI5Mjk2MD
AxMH0sInVXZlV3SkhCVmhSZGxlTXoiOnsiZGlzY3Vzc2lvbklk
IjoiQjNXNkFwTVlFdzZTeXZScSIsInN1YiI6ImdoOjY4MjUwMz
UwIiwidGV4dCI6Ik5hbWUgaXMgbm90IG1hdGNoaW5nIHRoZSBp
bnRyb2R1Y3Rpb24gXCJCZWFjb24gcGhhc2VcIiIsImNyZWF0ZW
QiOjE1OTgyOTMwMzAzNDR9LCJDTnRtTXFBb1E4a3lNSjJmIjp7
ImRpc2N1c3Npb25JZCI6IkhQNHpkeU5EeXhReEFacHIiLCJzdW
IiOiJnaDo2ODI1MDM1MCIsInRleHQiOiJzeW5jaHJvbmljaXR5
IGVycm9yIiwiY3JlYXRlZCI6MTU5ODI5MzM3OTUyNn0sIjJtaH
lhZk8xcktqcVpZVE4iOnsiZGlzY3Vzc2lvbklkIjoibEU0TmpV
eU1jeU9WU2FKUSIsInN1YiI6ImdoOjY4MjUwMzUwIiwidGV4dC
I6IlNpbmNlIHRoaXMgaXMgbm90IGNvbnRyb2xsYWJsZSwgc2hv
dWxkIGl0IHJlYWxseSBiZSBjYWxsZWQgYSBwYXJhbWV0ZXI/Ii
wiY3JlYXRlZCI6MTU5ODI5MzcwOTA1N319LCJoaXN0b3J5Ijpb
LTE0MDcwNjk5MzcsLTEyMDMwMjk2NTgsLTY1MDcyMDgsLTEyOT
MyNDY3Miw0MjI3MzA2MzQsMTE3OTkwNDg4NCw0MTg2MDEwNDYs
MjA5ODg4MzUzOCwtMTIyMDYxOTk1NywxMDg1MDc2MiwtMjQzNj
I2NTY1LC0xMjUzODA5OTY0LDUzMjQ0MzI4MCw0OTk3MzgyNzJd
fQ==
-->