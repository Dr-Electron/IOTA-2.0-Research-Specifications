
# 5.3 Decentralised Random Number Generator for IOTA network - Specification  
  

This specification is part of IOTA 2.0 [Coordicide](https://coordicide.iota.org/).  
  
The module presented in this specification, decentralized random number generator (dRNG), allows for the decentralized generation of randomness for the IOTA 2.0 network. The dRNG protocol is divided into three phases. In the first phase, a committee of high mana nodes is selected. In the second setup phase, the committee members create a collective private key used in the third, beacon phase, where the random numbers are published in the Tangle.  
  
During the committee selection, we do not assume perfect agreement on the mana values, i.e., different nodes can have slightly different opinions on the mana values of other nodes. Obtaining the consensus on the mana values is the central part of this documentation. In the setup phase, a pair of collective private and public key is created in such a way that no individual committee member knows the entire private key. This is done using $(t,n)$ Distributed Key Generation (DKG), which does not rely on centralized, trusted third parties. In the beacon phase, messages containing random numbers can be signed with the private collective key when at least $t$ of the $n$ committee nodes sign a message with their private key share. All of the random number messages used in three phases are published in the Tangle.  
  
  
In the IOTA 2.0, decentralized random numbers are used in the FPC. Randomness increases the security of this consensus mechanism by keeping the voting threshold unknown for the potential attacker. However, FPC can be decoupled from random numbers, and the network is not halted if randomness is not produced anymore (although the security suffers). Possible usage of dRNG for other modules like autopeering, rate control, or smart contract are discussed, although currently, we do not plan to deploy them.  
  
To provide the dRNG for IOTA 2.0, we decided to use already existing works, including [Rabin](http://www.sciencedirect.com/science/article/pii/0022000083900429), [Shamir's Secret Sharing](https://en.wikipedia.org/wiki/Shamir%27s_Secret_Sharing); [Petersen secret sharing](https://www.cs.cornell.edu/courses/cs754/2001fa/129.PDF); (Boneh–Lynn–Shacham (BLS) signature scheme)[https://en.wikipedia.org/wiki/Boneh%E2%80%93Lynn%E2%80%93Shacham]; Syta (https://bford.info/pub/dec/random.pdf) and most notably open-source, practical implementation of dRNG: [drand](https://drand.love/). In this specification, we use the same cryptographic foundations as drand. The full specification of the drand protocol can be found here: https://github.com/drand/drand. We highly recommend reading it before continuing this specification. In particular the part responsible for [Drand: Cryptographic Background](https://hackmd.io/@nikkolasg/HyUAgm234). It describes both DKG and beacon phases on the cryptographic level. Since we adopted the same threshold scheme, we do not repeat this here.  
  
  
  
  
  
# 5.3.1 Dependencies  
  
  
1. Mana  
  
2. FPC  
  
Possibly, in the future:  
  
3. Autopeering  
  
4. Rate control  
  
  
  
  
  
  
  
  
# 5.3.2 Outline of the decentralized random number generation  
  
**1. COMMITTEE SELECTION:**  
  
a) Nodes declare willingness to be a committee member with a special ''application'' message  
  
b) Selection of $n$ top mana holders  
  
  
**2. DKG PHASE:**  
  
Distributed key generation phase. Takes place on the Tangle, participation can be publicly verified.  
  
**3. PUBLICATION PHASE:**  
  
Publication of the beacon messages in the Tangle  
  
  
  
  
  
  
# 5.3.3 Parameters  
  
  
  
  
  
1. The random number production frequency: $t_{ran}$  
  
*Random number is produced every $t_{ran}$ seconds.*  
  
  
  
2. The number of participating nodes: $m, m_2$.  
  
*The committee's size from top mana holders equals $m$; the size of the community committee (responsible for random backup number) equals $m_2$.*  
  
  
  
3. Committee seatizes: $n, n_2$  
  
*The number of identities (seats) in the high mana committee equals $n$. $n$ does not equal $m$ as specific nodes receive more than one seat, i.e., node publishes more than one beacon message.*  
  
  
  
4. Signature threshold parameter: $f \in [0,1]$ (percentage), $t \in \mathbb{N}$ (number of beacon messages needed to obtain randomness)  
  
*In order to find the next random number, $t$ or more beacon messages are required. $\left ($t =\lfloor nf \rfloor +1 \right )$).*  
  
  
  
5. Frequency of committee update: $Freq.$  
  
*The committee is selected every $Freq.$ units of time.*  
  
  
  
6. Time window of the ''application'' message submission: $\Delta_A$  
*Nodes that want to be in the committee have to issue a special ''application'' message in the Tangle within the time window, which lasts for $ \Delta_A $ units of time.*  
  
  
  
7. Time delay bound on the dRNG messages: $D_{RN}$  
  
*The network does not accept the dRNG messages with the timestamp off by more than $D_{RN}$ from node's local time. Derived from the protocol specification.*  
  
8. Size of $\mathbb{Z}_{p}$ group: $p$  
  
  
  
# 5.3.5 Committee selection  
  
  
  
  
To select the high mana committee, we need a consensus on the mana values. Unfortunately, different nodes have different views on the mana values, due to the slightly different clocks.  
  
The Tangle graph in IOTA 2.0 lacks an obvious 'reference point,' which could be used to calculate mana values. This is not a problem in blockchains where such a reference point could be every $k$-th block; neither it is a problem in IOTA 1.0 where milestones could be such reference. To solve this problem, we use the timestamps of the transactions and use a specific time as a reference point. Application messages are used to determine whether the node wants to participate in the committee, then the committee is formed from top $n$ highest mana holders.  
  
The committee selection process is analyzed in-depth in this article:  
https://www.overleaf.com/read/jdbhppqyxsvx  
(submitted to the conference, still in review)  
  
In this article, we also describe alternative methods of committee selection and analyze DAG distributed ledgers other than the Tangle.  
  
  
## 5.3.5.1 Application messages  
  
  
  
Application messages have to be submited within a time window of $\Delta_A$ units of time.  
  
In general, any node can issue an application message, and such a message would be accepted by the Tangle (assuming it passes rate control). However, we admit that for a low mana node, such behavior does not make much sense. Such nodes can decide not to take part in it. Multiple application messages are allowed. However, they are pointless and, in fact, costly as they have to pass the rate control mechanism.  
  
  
  
Assume that the committee should be formed at the time $t_0$. Remember that $D_{RN}$ is bound on accepting dRNG messages in the Tangle. Then no honest node accepts dRNG message with the timestamp different by more than $D_{RN}$ from its local time.  
Let us denote  
  
$$  
T_0 = t_0 - D_{RN}.  
$$  
  
Then we require the potential committee members to issue an application message in the Tangle with a timestamp from an interval.  
  
$$  
[T_0 -\Delta_A, T_0].  
$$  
  
The Mana value of all nodes would be calculated for the time $T_0 -\Delta_A $ (reference point).  
  
  
  
For nodes interested in committee participation, we provide a default application algorithm that tells node when to apply. Nodes can modify it; however, we encourage them to stick with it as it reduces the number of exchanged application messages.  
  
  
A node is said to be $M_\ell$ if it is among top $\ell$ top mana nodes (with respect to the time $T_0 -\Delta_A$).  
  
  
  
If a node $x$ is $M_{2m}$ then it issues an application at the time $T_0-\Delta_A$.  
  
  
For $k >2$ and a node $x$ which is $M_{m\cdot k}$ but not $M_{m\cdot (k-1)}$ ($m$ is the committee size) it submits a committee application if before the time $T_0- \Delta_A \frac{\ell-2}{\ell-1}$ there is less than $m$ valid application messages with mana greater then $x$'s mana.  
  
  
  
Pseudocode:  
```  
if (this_node_wants_to_participate_in_dRNG) then  
if (time == T_0-Delta_A)  
ell = what_is_my_ell_number(my_ID,MANA_vector)  
CALL APPLICATION_MESSAGE_SEND(ell)  
fi  
fi  
```  
  
```  
subroutine APPLICATION_MESSAGE_SEND(ell)  
if (ell <= 2) then  
timestamp = T_0-Delta_A  
send_application_message(timestamp)  
else  
wait_untill(T- Delta_A *(ell-2)/(ell-1))  
CALL what_is_my_mana  
if (number_of_valid_application_messages_with_mana_higher_than_mine < m) then  
send_application_message(timestamp)  
fi  
fi  
endsubroutine  
```  
  
  
  
If $m$ or more valid application messages had been issued to the Tangle, then the committee selection is considered valid, and the committee is formed from top $m$ mana nodes who applied.  
  
  
  
If committee selection was a failure, then the procedure should be repeated until success In general if the failed committee selection was supposed to end at time $t_n$ then the procedure is repeated with a new expected time of committee selection $t_{n+1} = t_n + D_{RN}+\Delta_A$  
  
  
  
# 5.3.6 DKG phase  
  
After successful committee selection, confirmed at the time $t_0, the DKG phase starts. In this phase, committee nodes exchange the Deal messages to produce a public/private collective key. Nodes should proceed with DKG message exchange as soon as committee selection is confirmed (time $t_0$).  
  
  
If any committee node refuses to create a collective key pair by not exchanging Deal DKG messages, the DKG phase fails. This can be confirmed at the time of $t_0 + D_{RN}$. Moreover, since the message exchange occurs on the Tangle, everybody can identify nodes that caused the failure. In the case of DKG phase failure, the entire committee selection is repeated. The malicious node can then be excluded from the new committee selection process by modifying the malicious node's mana to zero. This modification is applied only to the mana used in dRNG module. Mana values used for other purposes are unchanged. Moreover, modification is lifted after the committee is *successfully* selected,

i.e., the new committee produces its first beacon messages.  
  
  
If DKG phase failure is confirmed at the time $t_n + D_{RN}$, then the committee selection is repeated with a new expected time of committee selection $t_{n+1} = t_n +2*D_{RN}+\Delta_A$.  
  
  
  
# 5.3.7 Double seats in the committee  
  
Our research revealed that we could increase the security of dRNG beacon by granting double seats for half of the committee with the highest mana. Those nodes would receive two private keys (identities) with which they sign beacon messages in the Tangle. From the technical point of view, two seats are entirely separate, and issued messages can not be combined (even though physically signed by the same node). This modification increases mana required to "overtake" the committee, which is understood as gaining $t$ of seats in the committee. Without it, an attacker could gain more than $t$ seats in the committee with about 12% mana for $m=15$. With double seat proposal, minimal mana to overtake doubles.  
  
  
The total number of nodes with double seats equals $\lfloor n/2 \rfloor$ which makes the total number of identities in the committee equal  
  
$$  
n + \lfloor n/2 \rfloor = \left \lfloor 1\frac{1}{2}n \right \rfloor.  
$$  
  
  
  
  
  
  
# 5.3.8 Synching of the new committee nodes & duties of the old committee  
  
Before starting random number generations, committee nodes should synch up their clocks, with each other or some other central entity like atomic clock services.  
  
The old committee should stop producing random numbers only if the new committee was successfully selected and started producing random numbers. This is confirmed when $t$ or more beacon messages are produced by the new committee and can be read directly from the Tangle.  
  
  
  
# 5.3.9 Community dRNG  
  
Although unlikely, it is still possible that the mana committee fails to produce a random number. To increase liveness of the random number production in the IOTA 2.0, we will deploy multiple dRNG, which uses the same scheme, but the committee is pre-selected from community members. Details of the random number usage from different sources in FPC are described in specification 5.1.  
  
  
In the future, we also want to deploy backup randomness beacon based on VDFs.  
  
  
  
# 5.3.10 Collective beacon message  
  
To recover the random number from beacon messages node needs to perform Lagrange interpolation. Although not very computationally costly, this procedure would need to be completed by each node in the network.  
  
  
  
To avoid that, we propose that committee nodes produce the collective beacon message which contains already computed random number (committee nodes perform Lagrange interpolation on their own). Since the committee size is small and the expected number of TPS for IOTA large, we require all committee members to produce this collective beacon message as soon as they receive $t$ beacon messages.  
  
  
  
  
The cost of getting randomness from collective beacon would be reduced as only the signature verification would be required.  
  
  
  
  
  
  
Non-committee nodes behave as follows: If randomness is required at the time when no collective beacon is available but more than $t$ beacon messages are published, then the nodes perform Lagrange interpolation themself.  
  
  
  
# 5.3.11 Payload layout  
  
## 5.3.11.1 Application messages  
  
Committee candidature payload  
| Field | Type | Description |  
|------------|--------|----------------------------------|  
| type | byte | message type |  
| instanceID | uint32 | identifier of the dRAND instance |  
  
  
  
  
## 5.3.11.2 DRK generation  
  
Deal payload  
| Field | Type | Description |  
|------------|---------------|----------------------------------|  
| type | byte | message type |  
| instanceID | uint32 | identifier of the dRAND instance |  
| fromIndex | uint32 | index of the dealer |  
| toIndex | uint32 | index of the verifier |  
| deal | encryptedDeal | encrypted share |  
  
encryptedDeal struct  
| Field | Type | Description |  
|----------------|--------|-------------------------------------------------------------------------------|  
| dhkey | bytes | ephemereal diffie hellman key |  
| nonce | bytes | nonce used in AES-GCM |  
| encryptedShare | bytes | ciphertext of the share |  
| threshold* | uint32 | threshold of the secret sharing protocol (decided during committee selection) |  
| commitments | bytes | commitments of the polynomial used to derive the share |  
  
  
## 5.3.11.3 Rrandomness revealing messages  
  
Beacon payload  
| Field | Type | Description |  
|------------------|--------|----------------------------------------------------------------|  
| type | byte | message type |  
| instanceID | uint32 | identifier of the dRAND instance |  
| round | uint64 | round of the current beacon |  
| partialPubKey | bytes | public key of the issuer |  
| partialSignature | bytes | partial signature of the beacon |  
  
  
Collective beacon payload  
| Field | Type | Description |  
|---------------|--------|------------------------------------------------|  
| type | byte | message type |  
| instanceID | uint32 | identifier of the dRAND instance |  
| round | uint64 | round of the current beacon |  
| previous | bytes | signature of the previous beacon |  
| signature | bytes | signature of the new beacon |  
| distributedPK | bytes | distributed public key |  
  
  
  
  
  
  
  
  
  
# 5.3.12 Parameters values  
  
1. Random number produced every: $t_{ran}= 10$ $[sec]$  
  
2. Committee size: $m= 10$ $[nodes]$  
  
3. Identities in the committee: $n= 15$ $[nodes]$  
  
4. drand threshold parameter: $f = 0.51$, $t=8$ $[nodes]$  
  
5. Frequency of committee selection: $Freq. = 1$ $[day]$  
  
6. Time interval for committee ''application'' submission $\Delta_A =4$ $[min]$  
  
7. Time delay bound of the dRNG messages: $D_{RN} = 2*w+D = 35 [min]$ ($w,D$ are values of the parameters from XXX)  
  
  
  
  
  
  
# 5.3.13 Further research and planned improvements  
  
1. Committee failure detection and recovery mechanism  
  
2. Backup random beacon based on VDFs  
  
3. How much mana does the attacker need to overtake committee and multiple seats in the committee – further research  
  
4. Probability of false-positive of committee failure detection (point 1)
<!--stackedit_data:
eyJkaXNjdXNzaW9ucyI6eyJnbUluNFhoZWtvcVpFdGcyIjp7In
RleHQiOiJJZiBhIG5vZGUgc2VuZHMgbW9yZSB0aGFuIG9uZSBh
cHBsaWNhdGlvbiBtZXNzYWdlIHRoZXkgYXJlIHRyZWF0ZWQgYX
MgY29uZmxpY3Rz4oCmIiwic3RhcnQiOjE2Njg2LCJlbmQiOjB9
LCJ2TDNqQW9HYXVXdEEwM082Ijp7InRleHQiOiJTdWNoIHRyYW
5zYWN0aW9uIHdvdWxkIGJlIHVzZWQgdG8gZXh0cmFjdCAqb25s
eSogYSBtYW5hIHZhbHVlIG9mIGFuIGlzc3Vpbmcgbm9k4oCmIi
wic3RhcnQiOjE2Njg2LCJlbmQiOjB9LCIzTWdPTkYwRHFuZUVn
VG5rIjp7InRleHQiOiJkZWNsYXJlZCBtYW5hICAgICAgICAgIC
AgICAgICAgICB8Iiwic3RhcnQiOjE2Njg2LCJlbmQiOjB9LCIw
RG16aGJkbnVybEF1T2NLIjp7InRleHQiOiJXZSBjYW4gYmUgc3
VyZSB0aGF0IGFmdGVyIHRoZSB0aW1lICR0XzAgLSBcXERlbHRh
X0MkIG5vIGFwcGxpY2F0aW9uIG1lc3NhZ2Ugd2lsbOKApiIsIn
N0YXJ0IjoxNjY4NiwiZW5kIjowfSwiMXRyZHBENXliVU82dmt4
ZyI6eyJ0ZXh0IjoiVG8gYXZvaWQgdGhhdCwgd2UgcHJvcG9zZS
B0aGF0IGNvbW1pdHRlZSBub2RlcyBwcm9kdWNlIHRoZSBjb2xs
ZWN0aXZlIGJlYWNvbiBtZeKApiIsInN0YXJ0IjoxNjY4NiwiZW
5kIjowfSwiMXlOTUMxejZ4MjVab3Q2TCI6eyJ0ZXh0IjoiVGhp
cyBzcGVjaWZpY2N0aW9uIGlzIHBhcnQgb2YgSU9UQSAyLjAgW0
Nvb3JkaWNpZGVdKGh0dHBzOi8vY29vcmRpY2lkZS5pb3RhLm9y
Z+KApiIsInN0YXJ0IjoxNjY4NiwiZW5kIjowfSwiVFVNVDNVeV
NZeWRYUXpDSCI6eyJ0ZXh0IjoiSU9UQSAyLjAgcmVxdWlyZXMg
YSBkZWNlbnRyYWxpemVkIHJhbmRvbSBudW1iZXIgZ2VuZXJhdG
9yIChkUm90IGFzc3VlIHBlcmZlY3QgYeKApiIsInN0YXJ0Ijox
NjY4NiwiZW5kIjowfX0sImNvbW1lbnRzIjp7IjRCZWJPV01Zdn
JxSDFFOGgiOnsiZGlzY3Vzc2lvbklkIjoiZ21JbjRYaGVrb3Fa
RXRnMiIsInN1YiI6ImdoOjUwNjYxODQ0IiwidGV4dCI6Ikhvdy
BhcmUgdGhleSB0cmVhdGVkIGxpa2UgY29uZmxpY3RzPyAgRG8g
d2Ugdm90ZSBvbiB0aGVtPyIsImNyZWF0ZWQiOjE1OTYwODk2Nj
E1NDl9LCJndzBQZ2xBVjlocklMMElaIjp7ImRpc2N1c3Npb25J
ZCI6ImdtSW40WGhla29xWkV0ZzIiLCJzdWIiOiJnaDo1MDY2MT
g0NCIsInRleHQiOiJJZiB3ZSBoYXZlIHRvIHZvdGUgb24gdGhl
bSwgdGhlbiB3ZSBuZWVkIHRvIGFuYWx5emUgdGhlIHNwYW0gY3
JlYXRlZCBieSB0aGVzZSB2b3RlcyBhbmQgaW5jbHVkZSBkZXRh
aWxzIG9uIGhvdyB0aGUgb3BpbmlvbnMgYXJlIHNldCBldGMuIi
wiY3JlYXRlZCI6MTU5NjA4OTcwODc2MX0sIjVCY0l3VTAzbTcw
bFRqREIiOnsiZGlzY3Vzc2lvbklkIjoidkwzakFvR2F1V3RBMD
NPNiIsInN1YiI6ImdoOjUwNjYxODQ0IiwidGV4dCI6IkkgdGhp
bmsgeW91IG5lZWQgdG8gYmUgbW9yZSBzcGVjaWZpYyBhYm91dC
B3aGF0IHlvdSBpbmNsdWRlIGluIGhlcmU/ICBUaGUgbWFuYSBi
YWxhbmNlIG9yIHRoZSBlZmZlY3RpdmUgbWFuYT8iLCJjcmVhdG
VkIjoxNTk2MDkwMTM5NDgzfSwiZWpjeVlNMkFnaFBPeWt2cCI6
eyJkaXNjdXNzaW9uSWQiOiIzTWdPTkYwRHFuZUVnVG5rIiwic3
ViIjoiZ2g6NTA2NjE4NDQiLCJ0ZXh0IjoiVGhpcyBuZWVkcyB0
byBiZSBzcGVjaWZpZWQuIiwiY3JlYXRlZCI6MTU5NjA5MDM5Mj
IwM30sIkNVeHZRdVhpZGI1VmV0RDgiOnsiZGlzY3Vzc2lvbklk
IjoiMERtemhiZG51cmxBdU9jSyIsInN1YiI6ImdoOjUwNjYxOD
Q0IiwidGV4dCI6IlVubGVzcyBcXERlbHRhX0MgaXMgYmlnZ2Vy
IHRoYW4gdywgdGhlIHRpbWUgc3RhbXAgd2luZG93IHBhcmFtZX
RlciwgdGhpcyBpcyBub3QgdHJ1ZS4iLCJjcmVhdGVkIjoxNTk2
MDkxMDk0NDgyfSwiQ3A2NjRHTFZNaFpPNWNIYiI6eyJkaXNjdX
NzaW9uSWQiOiJnbUluNFhoZWtvcVpFdGcyIiwic3ViIjoiZ2g6
NTA2NjE4NDQiLCJ0ZXh0IjoiV2h5IG5vdCB0YWtlIHRoZSBvbm
Ugd2l0aCB0aGUgbG93ZXIgdGltZXN0YW1wPyIsImNyZWF0ZWQi
OjE1OTYwOTExNTkwMjh9LCJ4Rm1YVnZieHVLbXpwNWhHIjp7Im
Rpc2N1c3Npb25JZCI6IjF0cmRwRDV5YlVPNnZreGciLCJzdWIi
OiJnaDo1MDY2MTg0NCIsInRleHQiOiJJIHRoaW5rIHRoaXMgc3
BlY2lmaWNhdGlvbiBvdmVyIGFsbCBsYWNrcyBkZXRhaWwuICBG
b3IgaW5zdGFuY2UsIHRoZSBhY3Rpb25zIGluIHRoaXMgc2VjdG
lvbiwgYW5kIHRoZSBpbXBsZW1lbnRhdGlvbiBvZiBEUkFORCBu
ZWVkIHRvIGJlIGRlc2NyaWJlZCBpbiBkZXRhaWwuIiwiY3JlYX
RlZCI6MTU5NjA5NDMxOTI3OH0sInhCTWpMTlhMWExFeEtSMDki
OnsiZGlzY3Vzc2lvbklkIjoiMXlOTUMxejZ4MjVab3Q2TCIsIn
N1YiI6ImdoOjY4MjUwMzUwIiwidGV4dCI6IlNvbWUgcHJvYmxl
bSBoYXBwZW5lZCBvbiBzeW5jaHJvbml6YXRpb24gYW5kIHRoZS
BmaWxlIGJlY2FtZSBhIGxpdHRsZSBtZXNzeS4gTmVlZCB0byBz
b2x2ZSIsImNyZWF0ZWQiOjE1OTc4MDEzNDc2NzR9LCI2WmFtak
xLaXdOY0U4d2N3Ijp7ImRpc2N1c3Npb25JZCI6IlRVTVQzVXlT
WXlkWFF6Q0giLCJzdWIiOiJnaDo2ODI1MDM1MCIsInRleHQiOi
JTYW1lIGFzIGFib3ZlIiwiY3JlYXRlZCI6MTU5NzgwMTM5NDUw
MX19LCJoaXN0b3J5IjpbLTE1MDQyMjcyMjAsNDk5NzM4MjcyXX
0=
-->