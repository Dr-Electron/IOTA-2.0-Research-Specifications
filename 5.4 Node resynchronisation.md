


# 5.4 Node resynchronisation in IOTA network - Specification 




The module presented in this specification allows for the node's resynchronization of the node with the network after as a result of the failure of the consensus mechanism.  Currently, the consensus mechanism for IOTA 2.0 is the Fast Probabilistic Consensus (FPC) (see Section 5.1). FPC was extensively researched and from it we concluded that it is secure even in the byzantine  environment - adversary controls the certain number of nodes in the network and intends to either delay or break the consensus. 


Due to its probabilistic nature, it is possible that a small number of nodes finalise FPC on an opposite opinion to the majority of the network. The role of the resynchronisation mechanism is to provide an automatic response to such event. Without such mechanism, the only alternative would be to manually restart the node. 


Note that the it is accurate to say that the resynchronisation procedure, together with FPC, redefines the consensus mechanism. To avoid the creation on new attack vectors on the consensus, the resynchronisation was designed to only be triggered when very strong evidence suggests that the node had a termination failure. 



The resynchronization procedure is divided into two steps:

1. Trigger step (evidence gathering);

2. Query step (opinion switching).



During the trigger step, the node periodically gathers evidence of potential transactions that finalised FPC on the wrong opinion . If this evidence is strong enough, the Query Step is called.

The Query Step is performed by querying a large part of the network of the network about the mentioned transaction. If the result of the query confirms the findings of the trigger step, then the node perform resynchronisation. 





# 5.4.3 ResynchrFPC and the probability of failure

# Realities 

Each reality is associated with a single transaction. 

What about the current reality? What transaction isation protocol

## 5.4.3.1 Variables and parameters  it associated with?

How to get mana associated with reality?

How to get information about the current reality from FPC messages of high mana holders? 

Bootstrapping? 



# Resynchronisation protocol

Resynchronisation protocol

## 5.4.3.1 Variables and parameters 

### Mana associated with reality

How do we know what mana is online?

## Query for the best reality 


# Resynchronisation protocol

## Variables and parameters 






`current_reality` Reality. Currently used reality.



`incom_tx_reality` Transaction. Transaction associated with currently used reality. 



`mana_response` Real number. The ratio of online mana that responded to node's query in the second step of the protocol. 



### Parameters 







`minimal_abs_mana_to_swich` Minimal absolute value of mana associated with reality $X$ (which is not current reality) required to go to step 2 (querry) ofd resynchronisation. 


`minimal_ratio_mana_to_swich` Minimal ratio of mana associated with reality $X$ (which is not curent reality) to mana of the curent reality required to go to step 2 (querry) odf resynchronisation. 


`mana_query`  Real number between 0 and 1. The ratio of online mana that node queries to synchronize in step 2 of resynchronization.



`min_mana_response` Real number between 0 and 1. The minimal required ratio of online mana that responded to a query in step 2 that allows for a continuation of the resynchronization process.



`query_parameter` Real number between 0 and 1. The parameter used in the query step of resynchronization. If a conflicting reality received more than `query_parameter` of mana weighted votes from the current reality then the node switches to the conflicting reality. 




# 5.4.4 Functions



`who_to_query(mana_ratio)`  one input: real number `mana_ratio`. Output is a list of random, online nodes with `mana_ratio` ratio of online mana.


`query_resynch_step2(tx1,tx2,set_of_nodes)` Subroutine. Takes 3 inputs: two transactions `tx1` and `tx2`; set of nodes to query `set_of_nodes`. Subroutine queries nodes from `set_of_nodes` about transactions `tx1` and `tx2`. Queried nodes respond to which transaction they like: `tx1`, `tx2`, or neither. Subroutine modifies 3 variables: `mana_response`; `query_result1`; `query_result2`. `mana_response` is equal to the ratio of online mana of nodes that responded to query. `query_result1` is a ratio of nodes who responded to query with like for transaction `tx1`; `query_result2` is a ratio of nodes who responded to query with like for transaction `tx2`.


 `swich_to_reality(tx)` Subroutine. Takes one input: one transaction. Subroutine switches reality from `current_reality` to the reality associated with the transaction `tx`. 





## 5.4.4.1 Pseudocode

Trigger Step:
```
if (incom_tx_reality =/= current_reality) then
    mana_associated_with_reality (incom_tx_reality) =+ mana_associated_with_tx (incom_tx)
    
    logical_1 = mana_associated_with_reality (incom_tx_reality) >  minimal_abs_mana_to_swich
    logical_2 = mana_associated_with_reality (incom_tx_reality) >  minimal_ratio_mana_to_swich * mana_associated_with_reality (current_reality) 
   
    if (logical_1 .AND. logical_2 ) then
      CALL Resynch_query(incom_tx,current_tx)
    fi   
fi
```
<!--- 
if (local_time mod timestep) then
    for con_real in conflicting_realities
        tx1 = reality_identifier(con_real) 
        tx2 = reality_identifier(curent_reality)
        t_0 = max(timestamp(tx1),timestamp(tx2))
        if (issued_mana(con_real,t_0,local_time) -issued_mana(curent_reality,t_0,local_time) > trigger_parameter) then 
           CALL Resynch_query(tx1,tx2)
        fi
     endfor
fi
-->


--------------------------------
Query step: 
Pseudocode of `Resynch_query(tx1,tx2)` subroutine

```
subroutine Resynch_query(tx1,tx2) 
   set_of_nodes = who_to_query(mana_query)
   mana_response =0
   do while (mana_response < min_mana_response)
      set_of_nodes = who_to_query(mana_query)
      CALL query_resynch_step2(tx1,tx2,set_of_nodes)
   endwhile
   if (query_result1 - query_result2 > query_parameter) then
      CALL swich_to_reality(tx1)
   fi
endsubroutine   
```

## 5.4.4.2 Timescale and priority of resynch messages

Resynchronization protocol is supposed to be used with extreme caution. Moreover, it should be activated only with a very small probability. As such, the node which resynchronizes can wait a long time before finally deciding to switch a reality. Thus we conclude that the resynchronization messages can have lower priority in responding than other messages. Also, the time window when the node who queries other nodes in the second step of resynchronization can be bigger, even of the order of minutes. 





## 5.4.4.3 Values of the parameters

` minimal_abs_mana_to_swich` = We don't know yet, we are waiting for the testnet with mana data. Probably not less than 1000Gi i.e.: mana associated with 1Gi sitting on one address for 3 years

`minimal_ratio_mana_to_swich` = 3.0


`query_parameter` = 0.5

`mana_query` = 0.75 

`min_mana_response` = 0.5





# 5.4.5 Messages layout




## 5.4.5.1 Resynchronization query request

Committee candidature payload
| Field      | Type   | Description                      |
|------------|--------|----------------------------------|
| type       | byte   | message type                     |
| tx1        | uint32 | identifier of the first tx       |
| tx2        | uint32 | identifier of the second tx      |



## 5.4.5.2 Resynchronization query answer


| Field      | Type          | Description                      |
|------------|---------------|----------------------------------|
| type       | byte          | message type                     |
| answer     | 2 bits        | tx1,tx2, or both disliked        |



<!--stackedit_data:
eyJkaXNjdXNzaW9ucyI6eyJVNHJMbzBKa2owc3NTOTE0Ijp7In
RleHQiOiJFYWNoIHJlYWxpdHkgaXMgYXNzb2NpYXRlZCB3aXRo
IGEgc2luZ2xlIHRyYW5zYWN0aW9uLiBcblxuV2hhdCBhYm91dC
B0aGUgY3VycmVudOKApiIsInN0YXJ0IjoyODI4LCJlbmQiOjMx
MDV9LCJYWk9Qa041VWhnbU1wR3V4Ijp7InRleHQiOiJgaW5jb2
1fdHhfcmVhbGl0eWAgVHJhbnNhY3Rpb24uIFRyYW5zYWN0aW9u
IGFzc29jaWF0ZWQgd2l0aCBjdXJyZW50bHkgdXNlZCByZWFs4o
CmIiwic3RhcnQiOjMzMzIsImVuZCI6MzQxNX0sInFZQXdtTWUx
ZlNpbmh6ZE0iOnsidGV4dCI6Im1lc3NhZ2UgdHlwZSAgICAgIC
AgICAgICAgICAgICAgIHxcbnwiLCJzdGFydCI6Nzc4NywiZW5k
Ijo3Nzg3fSwiYjZ1WHFrdEtVSUc0c1JEdCI6eyJ0ZXh0IjoiaX
NhdGlvbiBwIiwic3RhcnQiOjE5NjgsImVuZCI6MTk3N30sIkxM
YjRKZjFmU2xyY2lGM3IiOnsidGV4dCI6IkNvbW1pdHRlZSBjYW
5kaWRhdHVyZSBwYXlsb2FkIiwic3RhcnQiOjcxNTEsImVuZCI6
NzE4MH19LCJjb21tZW50cyI6eyJhYTdMNHUzd1pLMDdXeE9CIj
p7ImRpc2N1c3Npb25JZCI6IlU0ckxvMEprajBzc1M5MTQiLCJz
dWIiOiJnaDo1MDY2MTg0NCIsInRleHQiOiJXaGF0IGlzIHRoZS
ByZWFsdGlvbnNoaXAgYmV0d2VlbiB0aGVzZSBxdWVzdGlvbnMg
YW5kIHRoZSBzcGVjPyIsImNyZWF0ZWQiOjE1OTYwOTQ2ODEzND
B9LCJya0swc0pBalppbGtxR0RRIjp7ImRpc2N1c3Npb25JZCI6
IlhaT1BrTjVVaGdtTXBHdXgiLCJzdWIiOiJnaDo1MDY2MTg0NC
IsInRleHQiOiJJIGRvbnQgdW5kZXJzdGFuZCB0aGlzIiwiY3Jl
YXRlZCI6MTU5NjA5NDg0NTg1Mn0sIjB6ejNHSGRNYlhWZ1hiRk
QiOnsiZGlzY3Vzc2lvbklkIjoicVlBd21NZTFmU2luaHpkTSIs
InN1YiI6ImdoOjUwNjYxODQ0IiwidGV4dCI6Ik9iamVjdCB0eX
BlIiwiY3JlYXRlZCI6MTU5NjA5NDkzMTExM30sIlVlMWNlVkdM
ZjRZa0JHRmYiOnsiZGlzY3Vzc2lvbklkIjoiYjZ1WHFrdEtVSU
c0c1JEdCIsInN1YiI6ImdoOjY4MjUwMzUwIiwidGV4dCI6Ij8i
LCJjcmVhdGVkIjoxNTk3ODAyNDU1NzA5fSwid2o4dVl4dzZEd1
Z2a0lUNyI6eyJkaXNjdXNzaW9uSWQiOiJMTGI0SmYxZlNscmNp
RjNyIiwic3ViIjoiZ2g6NjgyNTAzNTAiLCJ0ZXh0IjoiPyIsIm
NyZWF0ZWQiOjE1OTc4MDI3OTM3Njh9fSwiaGlzdG9yeSI6Wy0x
Nzc0NDIzNDI0LC00Mzk3MDM1NzAsODQ0OTg4OTc3LDY3NDQ1Mj
E2NSwtNDg5NDI5MzA3LC0xNzY0NjEyMDk3LC0xNzAwNjk1NjQ5
LDEyNDE2OTgwOTYsLTE3Njg0ODAyNjIsLTMxNTA0MDU0MCwtOT
M1MzE0NTIxLDE4MTcxMzU1NTQsLTY5MDU1NjkyNCwtMTU5ODcz
OTk5LC03MDAzMjMzNjZdfQ==
-->