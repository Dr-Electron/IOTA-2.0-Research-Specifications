


# 5.4 Node resynchronisation in IOTA network - Specification 




The module presented in this specification allows for the node's resynchronization of the node with the network after as a result of the failure of the consensus mechanism.  Currently, the consensus mechanism for IOTA 2.0 is the Fast Probabilistic Consensus (FPC) (see Section 5.1). FPC was extensively researched and from it we concluded that it is secure even in the byzantine  environment - adversary controls the certain number of nodes in the network and intends to either delay or break the consensus. Due to its probabilistic nature, it is possible that a small number of nodes finalise FPC on an opposite opinion to the majority of the network. 



The role of the resynchronisation mechanism is to provide an automatic response to such an eventof a node which fell out of synch. Without this mode, the only alternative would be to manually "kill" the node and set it up again. 



Note that the resynchronization mechanism can, in fact, "overwrite" FPC as it is a new finalization procedure on top of FPC. This opens the protocol for new attack vectors. WithHaving this in mind, we designed the rResynchronizsation as a procedure startedwhich is taken only whenif very strong evidence suggests that the node is out of synch. 



The resynchronization procedure is divided into two steps:

1. Trigger step (evidence gathering)

2. Query step (actual resynchronization)



During the first one, node periodically gathers evidence of potential falling out of synch. If this with the network. If enough evidence is gathe case,red the node tries to confirm the possibletential falling out of synch. This is done by the and query ofies the majority of the network about it. If the result of the query confirms the findings of the trigger step, then the node adapts resynchronizesation. 








# 5.4.3 ResynchrFPC and the probability of failure

# Realities 

Each reality is associated with a single transaction. 

What about the current reality? What transaction isation protocol

## 5.4.3.1 Variables and parameters  it associated with?

How to get mana associated with reality?

How to get information about the current reality from FPC messages of high mana holders? 

Bootstrapping? 



# Resynchronisation protocol

Resynchronisation protocol

## 5.4.3.1 Variables and parameters 

### Mana associated with reality

How do we know what mana is online?

## Query for the best reality 


# Resynchronisation protocol

## Variables and parameters 






`current_reality` Reality. Currently used reality.



`incom_tx_reality` Transaction. Transaction associated with currently used reality. 



`mana_response` Real number. The ratio of online mana that responded to node's query in the second step of the protocol. 



### Parameters 







`minimal_abs_mana_to_swich` Minimal absolute value of mana associated with reality $X$ (which is not current reality) required to go to step 2 (querry) ofd resynchronisation. 


`minimal_ratio_mana_to_swich` Minimal ratio of mana associated with reality $X$ (which is not curent reality) to mana of the curent reality required to go to step 2 (querry) odf resynchronisation. 


`mana_query`  Real number between 0 and 1. The ratio of online mana that node queries to synchronize in step 2 of resynchronization.



`min_mana_response` Real number between 0 and 1. The minimal required ratio of online mana that responded to a query in step 2 that allows for a continuation of the resynchronization process.



`query_parameter` Real number between 0 and 1. The parameter used in the query step of resynchronization. If a conflicting reality received more than `query_parameter` of mana weighted votes from the current reality then the node switches to the conflicting reality. 




# 5.4.4 Functions



`who_to_query(mana_ratio)`  one input: real number `mana_ratio`. Output is a list of random, online nodes with `mana_ratio` ratio of online mana.


`query_resynch_step2(tx1,tx2,set_of_nodes)` Subroutine. Takes 3 inputs: two transactions `tx1` and `tx2`; set of nodes to query `set_of_nodes`. Subroutine queries nodes from `set_of_nodes` about transactions `tx1` and `tx2`. Queried nodes respond to which transaction they like: `tx1`, `tx2`, or neither. Subroutine modifies 3 variables: `mana_response`; `query_result1`; `query_result2`. `mana_response` is equal to the ratio of online mana of nodes that responded to query. `query_result1` is a ratio of nodes who responded to query with like for transaction `tx1`; `query_result2` is a ratio of nodes who responded to query with like for transaction `tx2`.


 `swich_to_reality(tx)` Subroutine. Takes one input: one transaction. Subroutine switches reality from `current_reality` to the reality associated with the transaction `tx`. 





## 5.4.4.1 Pseudocode

Trigger Step:
```
if (incom_tx_reality =/= current_reality) then
    mana_associated_with_reality (incom_tx_reality) =+ mana_associated_with_tx (incom_tx)
    
    logical_1 = mana_associated_with_reality (incom_tx_reality) >  minimal_abs_mana_to_swich
    logical_2 = mana_associated_with_reality (incom_tx_reality) >  minimal_ratio_mana_to_swich * mana_associated_with_reality (current_reality) 
   
    if (logical_1 .AND. logical_2 ) then
      CALL Resynch_query(incom_tx,current_tx)
    fi   
fi
```
<!--- 
if (local_time mod timestep) then
    for con_real in conflicting_realities
        tx1 = reality_identifier(con_real) 
        tx2 = reality_identifier(curent_reality)
        t_0 = max(timestamp(tx1),timestamp(tx2))
        if (issued_mana(con_real,t_0,local_time) -issued_mana(curent_reality,t_0,local_time) > trigger_parameter) then 
           CALL Resynch_query(tx1,tx2)
        fi
     endfor
fi
-->


--------------------------------
Query step: 
Pseudocode of `Resynch_query(tx1,tx2)` subroutine

```
subroutine Resynch_query(tx1,tx2) 
   set_of_nodes = who_to_query(mana_query)
   mana_response =0
   do while (mana_response < min_mana_response)
      set_of_nodes = who_to_query(mana_query)
      CALL query_resynch_step2(tx1,tx2,set_of_nodes)
   endwhile
   if (query_result1 - query_result2 > query_parameter) then
      CALL swich_to_reality(tx1)
   fi
endsubroutine   
```

## 5.4.4.2 Timescale and priority of resynch messages

Resynchronization protocol is supposed to be used with extreme caution. Moreover, it should be activated only with a very small probability. As such, the node which resynchronizes can wait a long time before finally deciding to switch a reality. Thus we conclude that the resynchronization messages can have lower priority in responding than other messages. Also, the time window when the node who queries other nodes in the second step of resynchronization can be bigger, even of the order of minutes. 





## 5.4.4.3 Values of the parameters

` minimal_abs_mana_to_swich` = We don't know yet, we are waiting for the testnet with mana data. Probably not less than 1000Gi i.e.: mana associated with 1Gi sitting on one address for 3 years

`minimal_ratio_mana_to_swich` = 3.0


`query_parameter` = 0.5

`mana_query` = 0.75 

`min_mana_response` = 0.5





# 5.4.5 Messages layout




## 5.4.5.1 Resynchronization query request

Committee candidature payload
| Field      | Type   | Description                      |
|------------|--------|----------------------------------|
| type       | byte   | message type                     |
| tx1        | uint32 | identifier of the first tx       |
| tx2        | uint32 | identifier of the second tx      |



## 5.4.5.2 Resynchronization query answer


| Field      | Type          | Description                      |
|------------|---------------|----------------------------------|
| type       | byte          | message type                     |
| answer     | 2 bits        | tx1,tx2, or both disliked        |



<!--stackedit_data:
eyJkaXNjdXNzaW9ucyI6eyJVNHJMbzBKa2owc3NTOTE0Ijp7In
RleHQiOiJFYWNoIHJlYWxpdHkgaXMgYXNzb2NpYXRlZCB3aXRo
IGEgc2luZ2xlIHRyYW5zYWN0aW9uLiBcblxuV2hhdCBhYm91dC
B0aGUgY3VycmVudOKApiIsInN0YXJ0IjoyODk4LCJlbmQiOjMx
NzV9LCJYWk9Qa041VWhnbU1wR3V4Ijp7InRleHQiOiJgaW5jb2
1fdHhfcmVhbGl0eWAgVHJhbnNhY3Rpb24uIFRyYW5zYWN0aW9u
IGFzc29jaWF0ZWQgd2l0aCBjdXJyZW50bHkgdXNlZCByZWFs4o
CmIiwic3RhcnQiOjM0MDIsImVuZCI6MzQ4NX0sInFZQXdtTWUx
ZlNpbmh6ZE0iOnsidGV4dCI6Im1lc3NhZ2UgdHlwZSAgICAgIC
AgICAgICAgICAgICAgIHxcbnwiLCJzdGFydCI6Nzg1NywiZW5k
Ijo3ODU3fSwieHBOdWs4MDdRQUw2bnNNViI6eyJ0ZXh0IjoiZm
VsbCBvdXQgb2Ygc3luY2giLCJzdGFydCI6ODM4LCJlbmQiOjg1
NX0sIklKbmw5alE0SjFpaTR0dVYiOnsidGV4dCI6Ilwia2lsbF
wiIiwic3RhcnQiOjkxOCwiZW5kIjo5MjR9LCJHSjdDbml0NldW
azdSTEpvIjp7InRleHQiOiJmaW5hbGl6YXRpb24iLCJzdGFydC
I6MTA0NiwiZW5kIjoxMDU4fSwiRUt1bGt6d3pQQ21SSEJ4RyI6
eyJ0ZXh0IjoiRHVyaW5nIHRoZSBmaXJzdCBvbmUsIG5vZGUgcG
VyaW9kaWNhbGx5IGdhdGhlcnMgZXZpZGVuY2Ugb2YgcG90ZW50
aWFsIGZhbGxpbmcgb+KApiIsInN0YXJ0IjoxNDQ5LCJlbmQiOj
E4NTd9LCJiNnVYcWt0S1VJRzRzUkR0Ijp7InRleHQiOiJpc2F0
aW9uIHAiLCJzdGFydCI6MjAzOCwiZW5kIjoyMDQ3fSwiTExiNE
pmMWZTbHJjaUYzciI6eyJ0ZXh0IjoiQ29tbWl0dGVlIGNhbmRp
ZGF0dXJlIHBheWxvYWQiLCJzdGFydCI6NzIyMSwiZW5kIjo3Mj
UwfX0sImNvbW1lbnRzIjp7ImFhN0w0dTN3WkswN1d4T0IiOnsi
ZGlzY3Vzc2lvbklkIjoiVTRyTG8wSmtqMHNzUzkxNCIsInN1Yi
I6ImdoOjUwNjYxODQ0IiwidGV4dCI6IldoYXQgaXMgdGhlIHJl
YWx0aW9uc2hpcCBiZXR3ZWVuIHRoZXNlIHF1ZXN0aW9ucyBhbm
QgdGhlIHNwZWM/IiwiY3JlYXRlZCI6MTU5NjA5NDY4MTM0MH0s
InJrSzBzSkFqWmlsa3FHRFEiOnsiZGlzY3Vzc2lvbklkIjoiWF
pPUGtONVVoZ21NcEd1eCIsInN1YiI6ImdoOjUwNjYxODQ0Iiwi
dGV4dCI6IkkgZG9udCB1bmRlcnN0YW5kIHRoaXMiLCJjcmVhdG
VkIjoxNTk2MDk0ODQ1ODUyfSwiMHp6M0dIZE1iWFZnWGJGRCI6
eyJkaXNjdXNzaW9uSWQiOiJxWUF3bU1lMWZTaW5oemRNIiwic3
ViIjoiZ2g6NTA2NjE4NDQiLCJ0ZXh0IjoiT2JqZWN0IHR5cGUi
LCJjcmVhdGVkIjoxNTk2MDk0OTMxMTEzfSwiQm1TbG1hMGVIWj
BpYkJYVyI6eyJkaXNjdXNzaW9uSWQiOiJ4cE51azgwN1FBTDZu
c01WIiwic3ViIjoiZ2g6NjgyNTAzNTAiLCJ0ZXh0Ijoic291bm
RzIGluZm9ybWFsIiwiY3JlYXRlZCI6MTU5NzgwMTYxOTgyNH0s
Img2bDlvYXFXZWUydVpPYjMiOnsiZGlzY3Vzc2lvbklkIjoiSU
pubDlqUTRKMWlpNHR1ViIsInN1YiI6ImdoOjY4MjUwMzUwIiwi
dGV4dCI6InJlc3RhcnQiLCJjcmVhdGVkIjoxNTk3ODAxNjM1Nj
Y3fSwiMXhNamJHTmQxSmk5aDQ0RCI6eyJkaXNjdXNzaW9uSWQi
OiJHSjdDbml0NldWazdSTEpvIiwic3ViIjoiZ2g6NjgyNTAzNT
AiLCJ0ZXh0IjoiRlBDIGlzIG5ldmVyIGRlZmluZWQgYSBhcyBh
IGZpbmFsaXphdGlvbiBtZWNoYW5pc20iLCJjcmVhdGVkIjoxNT
k3ODAyNDA0NjM5fSwicDRsMjhrT2g5Y2xwT2p0RCI6eyJkaXNj
dXNzaW9uSWQiOiJFS3Vsa3p3elBDbVJIQnhHIiwic3ViIjoiZ2
g6NjgyNTAzNTAiLCJ0ZXh0IjoiZ3JhbW1hciIsImNyZWF0ZWQi
OjE1OTc4MDI0MzU0MTR9LCJVZTFjZVZHTGY0WWtCR0ZmIjp7Im
Rpc2N1c3Npb25JZCI6ImI2dVhxa3RLVUlHNHNSRHQiLCJzdWIi
OiJnaDo2ODI1MDM1MCIsInRleHQiOiI/IiwiY3JlYXRlZCI6MT
U5NzgwMjQ1NTcwOX0sIndqOHVZeHc2RHdWdmtJVDciOnsiZGlz
Y3Vzc2lvbklkIjoiTExiNEpmMWZTbHJjaUYzciIsInN1YiI6Im
doOjY4MjUwMzUwIiwidGV4dCI6Ij8iLCJjcmVhdGVkIjoxNTk3
ODAyNzkzNzY4fX0sImhpc3RvcnkiOlstOTE1MTc4OTMzLDg0ND
k4ODk3Nyw2NzQ0NTIxNjUsLTQ4OTQyOTMwNywtMTc2NDYxMjA5
NywtMTcwMDY5NTY0OSwxMjQxNjk4MDk2LC0xNzY4NDgwMjYyLC
0zMTUwNDA1NDAsLTkzNTMxNDUyMSwxODE3MTM1NTU0LC02OTA1
NTY5MjQsLTE1OTg3Mzk5OSwtNzAwMzIzMzY2XX0=
-->