


# 5.4 Node resynchronisation in IOTA network - Specification 




This specificaction is part of [Coordicide](https://coordicide.iota.org/).



The module presented in this specification, resynchronization, allows for the node's resynchronization of the node with the network after it was desynchronized. Desynchronisation might be a result of the failure of the consensus mechanism.  Currently, the consensus mechanism for the first version of the coordicade is Fast Probabilistic Consensus (FPC), for more see [FPC-BI: Fast Probabilistic Consensus within Byzantine Infrastructures"](https://arxiv.org/abs/1905.10895) and [specification of FPC modue](https://hackmd.io/s/HkFbpbTrU). Researchers at IF researched FPC thoroughly and deduced that this consensus mechanism is secure even in the Byzantine environment - adversary controls the certain number of nodes in the network and intends to either delay or break the consensus. However, due to its probabilistic nature, it is possible that with certain very small (although nonzero) probability, several a small number of nodes finalize FPC on the opposite opinion different than the prest ofvailing in the network - fork occurs. For the details of such an event, we recommend reading through the simulations papers:  ["Robustness and efficiency..."](https://arxiv.org/abs/1911.08787) and ["Fast Probabilistic Consensus with Weighted Votes"](https://www.overleaf.com/project/5e3a96c9ebfeb20001821bb5) where this probability and improvements to the protocol are discussed.



The role of the resynchronization role is to provide an automatic response to such an eventof a node which fell out of synch. Without this mode, the only alternative would be to manually "kill" the node and set it up again. 



Note that the resynchronization mechanism can, in fact, "overwrite" FPC as it is a new finalization procedure on top of FPC. This opens the protocol for new attack vectors. WithHaving this in mind, we designed the rResynchronizsation as a procedure startedwhich is taken only whenif very strong evidence suggests that the node is out of synch. 



The resynchronization procedure is divided into two steps:

1. Trigger step (evidence gathering)

2. Query step (actual resynchronization)



During the first one, node periodically gathers evidence of potential falling out of synch. If this with the network. If enough evidence is gathe case,red the node tries to confirm the possibletential falling out of synch. This is done by the and query ofies the majority of the network about it. If the result of the query confirms the findings of the trigger step, then the node adapts resynchronizesation. 








# 5.4.3 ResynchrFPC and the probability of failure

# Realities 

Each reality is associated with a single transaction. 

What about the current reality? What transaction isation protocol

## 5.4.3.1 Variables and parameters  it associated with?

How to get mana associated with reality?

How to get information about the current reality from FPC messages of high mana holders? 

Bootstrapping? 



# Resynchronisation protocol

Resynchronisation protocol

## 5.4.3.1 Variables and parameters 

#### Variables and parameters 






`current_reality` Reality. Currently used reality.



`incom_tx_reality` Transaction. Transaction associated with currently used reality. 



`mana_response` Real number. The ratio of online mana that responded to node's query in the second step of the protocol. 



### Parameters 







`minimal_abs_mana_to_swich` Minimal absolute value of mana associated with reality $X$ (which is not current reality) required to go to step 2 (querry) ofd resynchronisation. 


`minimal_ratio_mana_to_swich` Minimal ratio of mana associated with reality $X$ (which is not curent reality) to mana of the curent reality required to go to step 2 (querry) odf resynchronisation. 


`mana_query`  Real number between 0 and 1. The ratio of online mana that node queries to synchronize in step 2 of resynchronization.



`min_mana_response` Real number between 0 and 1. The minimal required ratio of online mana that responded to a query in step 2 that allows for a continuation of the resynchronization process.



`query_parameter` Real number between 0 and 1. The parameter used in the query step of resynchronization. If a conflicting reality received more than `query_parameter` of mana weighted votes from the current reality then the node switches to the conflicting reality. 




# 5.4.4 Functions



`who_to_query(mana_ratio)`  one input: real number `mana_ratio`. Output is a list of random, online nodes with `mana_ratio` ratio of online mana.


`query_resynch_step2(tx1,tx2,set_of_nodes)` Subroutine. Takes 3 inputs: two transactions `tx1` and `tx2`; set of nodes to query `set_of_nodes`. Subroutine queries nodes from `set_of_nodes` about transactions `tx1` and `tx2`. Queried nodes respond to which transaction they like: `tx1`, `tx2`, or neither. Subroutine modifies 3 variables: `mana_response`; `query_result1`; `query_result2`. `mana_response` is equal to the ratio of online mana of nodes that responded to query. `query_result1` is a ratio of nodes who responded to query with like for transaction `tx1`; `query_result2` is a ratio of nodes who responded to query with like for transaction `tx2`.


 `swich_to_reality(tx)` Subroutine. Takes one input: one transaction. Subroutine switches reality from `current_reality` to the reality associated with the transaction `tx`. 





## 5.4.4.1 Pseudocode

Trigger Step:
```
if (incom_tx_reality =/= current_reality) then
    mana_associated_with_reality (incom_tx_reality) =+ mana_associated_with_tx (incom_tx)
    
    logical_1 = mana_associated_with_reality (incom_tx_reality) >  minimal_abs_mana_to_swich
    logical_2 = mana_associated_with_reality (incom_tx_reality) >  minimal_ratio_mana_to_swich * mana_associated_with_reality (current_reality) 
   
    if (logical_1 .AND. logical_2 ) then
      CALL Resynch_query(incom_tx,current_tx)
    fi   
fi
```
<!--- 
if (local_time mod timestep) then
    for con_real in conflicting_realities
        tx1 = reality_identifier(con_real) 
        tx2 = reality_identifier(curent_reality)
        t_0 = max(timestamp(tx1),timestamp(tx2))
        if (issued_mana(con_real,t_0,local_time) -issued_mana(curent_reality,t_0,local_time) > trigger_parameter) then 
           CALL Resynch_query(tx1,tx2)
        fi
     endfor
fi
-->


--------------------------------
Query step: 
Pseudocode of `Resynch_query(tx1,tx2)` subroutine

```
subroutine Resynch_query(tx1,tx2) 
   mana_response =0
   do while (mana_response < min_mana_response)
      set_of_nodes = who_to_query(mana_query)
      CALL query_resynch_step2(tx1,tx2,set_of_nodes)
   endwhile
   if (query_result1 - query_result2 > query_parameter) then
      CALL swich_to_reality(tx1)
   fi
endsubroutine   
```

## 5.4.4.2 Timescale and priority of resynch messages

Resynchronization protocol is supposed to be used with extreme caution. Moreover, it should be activated only with a very small probability. As such, the node which resynchronizes can wait a long time before finally deciding to switch a reality. Thus we conclude that the resynchronization messages can have lower priority in responding than other messages. Also, the time window when the node who queries other nodes in the second step of resynchronization can be bigger, even of the order of minutes. 





## 5.4.4.3 Values of the parameters

` minimal_abs_mana_to_swich` = We don't know yet, we are waiting for the testnet with mana data. Probably not less than 1000Gi i.e.: mana associated with 1Gi sitting on one address for 3 years

`minimal_ratio_mana_to_swich` = 3.0


`query_parameter` = 0.5

`mana_query` = 0.75 

`min_mana_response` = 0.5





# 5.4.5 Messages layout




## 5.4.5.1 Resynchronization query request

Committee candidature payload
| Field      | Type   | Description                      |
|------------|--------|----------------------------------|
| type       | byte   | message type                     |
| tx1        | uint32 | identifier of the first tx       |
| tx2        | uint32 | identifier of the second tx      |



## 5.4.5.2 Resynchronization query answer


| Field      | Type          | Description                      |
|------------|---------------|----------------------------------|
| type       | byte          | message type                     |
| answer     | 2 bits        | tx1,tx2, or both disliked        |



<!--stackedit_data:
eyJkaXNjdXNzaW9ucyI6eyJVNHJMbzBKa2owc3NTOTE0Ijp7In
RleHQiOiJFYWNoIHJlYWxpdHkgaXMgYXNzb2NpYXRlZCB3aXRo
IGEgc2luZ2xlIHRyYW5zYWN0aW9uLiBcblxuV2hhdCBhYm91dC
B0aGUgY3VycmVudOKApiIsInN0YXJ0IjozNTY1LCJlbmQiOjM4
NDJ9LCJYWk9Qa041VWhnbU1wR3V4Ijp7InRleHQiOiJgaW5jb2
1fdHhfcmVhbGl0eWAgVHJhbnNhY3Rpb24uIFRyYW5zYWN0aW9u
IGFzc29jaWF0ZWQgd2l0aCBjdXJyZW50bHkgdXNlZCByZWFs4o
CmIiwic3RhcnQiOjQwNjksImVuZCI6NDE1Mn0sInFZQXdtTWUx
ZlNpbmh6ZE0iOnsidGV4dCI6Im1lc3NhZ2UgdHlwZSAgICAgIC
AgICAgICAgICAgICAgIHxcbnwiLCJzdGFydCI6ODQ4MSwiZW5k
Ijo4NDgxfSwieHBOdWs4MDdRQUw2bnNNViI6eyJ0ZXh0IjoiZm
VsbCBvdXQgb2Ygc3luY2giLCJzdGFydCI6MTYzNywiZW5kIjox
NjU0fSwiSUpubDlqUTRKMWlpNHR1ViI6eyJ0ZXh0IjoiXCJraW
xsXCIiLCJzdGFydCI6MTcxNywiZW5kIjoxNzIzfSwiR0o3Q25p
dDZXVms3UkxKbyI6eyJ0ZXh0IjoiZmluYWxpemF0aW9uIiwic3
RhcnQiOjE4NDUsImVuZCI6MTg1N30sIkVLdWxrend6UENtUkhC
eEciOnsidGV4dCI6IkR1cmluZyB0aGUgZmlyc3Qgb25lLCBub2
RlIHBlcmlvZGljYWxseSBnYXRoZXJzIGV2aWRlbmNlIG9mIHBv
dGVudGlhbCBmYWxsaW5nIG/igKYiLCJzdGFydCI6MjI0OCwiZW
5kIjoyNjU2fSwiYjZ1WHFrdEtVSUc0c1JEdCI6eyJ0ZXh0Ijoi
aXNhdGlvbiBwIiwic3RhcnQiOjI4MzcsImVuZCI6Mjg0Nn0sIk
xMYjRKZjFmU2xyY2lGM3IiOnsidGV4dCI6IkNvbW1pdHRlZSBj
YW5kaWRhdHVyZSBwYXlsb2FkIiwic3RhcnQiOjc4NDUsImVuZC
I6Nzg3NH19LCJjb21tZW50cyI6eyJhYTdMNHUzd1pLMDdXeE9C
Ijp7ImRpc2N1c3Npb25JZCI6IlU0ckxvMEprajBzc1M5MTQiLC
JzdWIiOiJnaDo1MDY2MTg0NCIsInRleHQiOiJXaGF0IGlzIHRo
ZSByZWFsdGlvbnNoaXAgYmV0d2VlbiB0aGVzZSBxdWVzdGlvbn
MgYW5kIHRoZSBzcGVjPyIsImNyZWF0ZWQiOjE1OTYwOTQ2ODEz
NDB9LCJya0swc0pBalppbGtxR0RRIjp7ImRpc2N1c3Npb25JZC
I6IlhaT1BrTjVVaGdtTXBHdXgiLCJzdWIiOiJnaDo1MDY2MTg0
NCIsInRleHQiOiJJIGRvbnQgdW5kZXJzdGFuZCB0aGlzIiwiY3
JlYXRlZCI6MTU5NjA5NDg0NTg1Mn0sIjB6ejNHSGRNYlhWZ1hi
RkQiOnsiZGlzY3Vzc2lvbklkIjoicVlBd21NZTFmU2luaHpkTS
IsInN1YiI6ImdoOjUwNjYxODQ0IiwidGV4dCI6Ik9iamVjdCB0
eXBlIiwiY3JlYXRlZCI6MTU5NjA5NDkzMTExM30sIkJtU2xtYT
BlSFowaWJCWFciOnsiZGlzY3Vzc2lvbklkIjoieHBOdWs4MDdR
QUw2bnNNViIsInN1YiI6ImdoOjY4MjUwMzUwIiwidGV4dCI6In
NvdW5kcyBpbmZvcm1hbCIsImNyZWF0ZWQiOjE1OTc4MDE2MTk4
MjR9LCJoNmw5b2FxV2VlMnVaT2IzIjp7ImRpc2N1c3Npb25JZC
I6IklKbmw5alE0SjFpaTR0dVYiLCJzdWIiOiJnaDo2ODI1MDM1
MCIsInRleHQiOiJyZXN0YXJ0IiwiY3JlYXRlZCI6MTU5NzgwMT
YzNTY2N30sIjF4TWpiR05kMUppOWg0NEQiOnsiZGlzY3Vzc2lv
bklkIjoiR0o3Q25pdDZXVms3UkxKbyIsInN1YiI6ImdoOjY4Mj
UwMzUwIiwidGV4dCI6IkZQQyBpcyBuZXZlciBkZWZpbmVkIGEg
YXMgYSBmaW5hbGl6YXRpb24gbWVjaGFuaXNtIiwiY3JlYXRlZC
I6MTU5NzgwMjQwNDYzOX0sInA0bDI4a09oOWNscE9qdEQiOnsi
ZGlzY3Vzc2lvbklkIjoiRUt1bGt6d3pQQ21SSEJ4RyIsInN1Yi
I6ImdoOjY4MjUwMzUwIiwidGV4dCI6ImdyYW1tYXIiLCJjcmVh
dGVkIjoxNTk3ODAyNDM1NDE0fSwiVWUxY2VWR0xmNFlrQkdGZi
I6eyJkaXNjdXNzaW9uSWQiOiJiNnVYcWt0S1VJRzRzUkR0Iiwi
c3ViIjoiZ2g6NjgyNTAzNTAiLCJ0ZXh0IjoiPyIsImNyZWF0ZW
QiOjE1OTc4MDI0NTU3MDl9LCJ3ajh1WXh3NkR3VnZrSVQ3Ijp7
ImRpc2N1c3Npb25JZCI6IkxMYjRKZjFmU2xyY2lGM3IiLCJzdW
IiOiJnaDo2ODI1MDM1MCIsInRleHQiOiI/IiwiY3JlYXRlZCI6
MTU5NzgwMjc5Mzc2OH19LCJoaXN0b3J5IjpbLTQ4OTQyOTMwNy
wtMTc2NDYxMjA5NywtMTcwMDY5NTY0OSwxMjQxNjk4MDk2LC0x
NzY4NDgwMjYyLC0zMTUwNDA1NDAsLTkzNTMxNDUyMSwxODE3MT
M1NTU0LC02OTA1NTY5MjQsLTE1OTg3Mzk5OSwtNzAwMzIzMzY2
XX0=
-->